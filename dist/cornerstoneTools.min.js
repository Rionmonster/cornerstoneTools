/*! cornerstoneTools - v0.6.2 - 2015-07-02 | (c) 2014 Chris Hafey | https://github.com/chafey/cornerstoneTools */
var cornerstoneTools=function(e,o,t){"use strict";function n(t){if(!("mousewheel"===t.originalEvent.type&&0===t.originalEvent.wheelDeltaY||"DOMMouseScroll"===t.originalEvent.type&&1===t.originalEvent.axis)){var n=t.currentTarget,r=o.pageToPixel(n,t.pageX||t.originalEvent.pageX,t.pageY||t.originalEvent.pageY);t=window.event||t;var a=t.wheelDelta||-t.detail||-t.originalEvent.detail,i=Math.max(-1,Math.min(1,a)),s={element:n,viewport:o.getViewport(n),image:o.getEnabledElement(n).image,direction:i,pageX:t.pageX||t.originalEvent.pageX,pageY:t.pageY||t.originalEvent.pageY,imageX:r.x,imageY:r.y};e(n).trigger("CornerstoneToolsMouseWheel",s)}}function r(o){e(o).on(i,n)}function a(o){e(o).unbind(i,n)}void 0===t&&(t={});var i="mousewheel DOMMouseScroll";return t.mouseWheelInput={enable:r,disable:a},t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t,n){"use strict";function r(o){e(o.element).trigger("CornerstoneToolsMouseDownActivate",o)}function a(r){var a=(r.data,r.currentTarget),i={page:t.point.pageToPoint(r),image:o.pageToPixel(a,r.pageX,r.pageY),client:{x:r.clientX,y:r.clientY}},s=n.copyPoints(i),l={event:r,which:r.which,viewport:o.getViewport(a),image:o.getEnabledElement(a).image,element:a,startPoints:i,lastPoints:s,currentPoints:i,deltaPoints:{x:0,y:0}},d=jQuery.Event("CornerstoneToolsMouseDoubleClick",l);e(l.element).trigger(d,l)}function i(a){function i(r){var a={page:t.point.pageToPoint(r),image:o.pageToPixel(l,r.pageX,r.pageY),client:{x:r.clientX,y:r.clientY}},i={page:t.point.subtract(a.page,c.page),image:t.point.subtract(a.image,c.image)},s={which:f,viewport:o.getViewport(l),image:o.getEnabledElement(l).image,element:l,startPoints:d,lastPoints:c,currentPoints:a,deltaPoints:i};return e(u.element).trigger("CornerstoneToolsMouseDrag",s),c=n.copyPoints(a),n.pauseEvent(r)}function s(n){var r={page:t.point.pageToPoint(n),image:o.pageToPixel(l,n.pageX,n.pageY),client:{x:n.clientX,y:n.clientY}},a={page:t.point.subtract(r.page,c.page),image:t.point.subtract(r.image,c.image)},g={event:n,which:f,viewport:o.getViewport(l),image:o.getEnabledElement(l).image,element:l,startPoints:d,lastPoints:c,currentPoints:r,deltaPoints:a},v=jQuery.Event("CornerstoneToolsMouseUp",g);e(u.element).trigger(v,g),e(document).off("mousemove",i),e(document).off("mouseup",s)}var l=(a.data,a.currentTarget),d={page:t.point.pageToPoint(a),image:o.pageToPixel(l,a.pageX,a.pageY),client:{x:a.clientX,y:a.clientY}},c=n.copyPoints(d),u={event:a,which:a.which,viewport:o.getViewport(l),image:o.getEnabledElement(l).image,element:l,startPoints:d,lastPoints:c,currentPoints:d,deltaPoints:{x:0,y:0}},g=jQuery.Event("CornerstoneToolsMouseDown",u);if(e(u.element).trigger(g,u),g.isImmediatePropagationStopped()===!1&&r(u)===!0)return n.pauseEvent(a);var f=a.which;return e(document).on("mousemove",i),e(document).on("mouseup",s),n.pauseEvent(a)}function s(r){var a=(r.data,r.currentTarget),i={page:t.point.pageToPoint(r),image:o.pageToPixel(a,r.pageX,r.pageY)},s=n.copyPoints(i),l=r.which,d={page:t.point.pageToPoint(r),image:o.pageToPixel(a,r.pageX,r.pageY),client:{x:r.clientX,y:r.clientY}},c={page:t.point.subtract(d.page,s.page),image:t.point.subtract(d.image,s.image)},u={which:l,viewport:o.getViewport(a),image:o.getEnabledElement(a).image,element:a,startPoints:i,lastPoints:s,currentPoints:d,deltaPoints:c};e(a).trigger("CornerstoneToolsMouseMove",u),s=n.copyPoints(d)}function l(o){e(o).on("mousedown",i),e(o).on("mousemove",s),e(o).on("dblclick",a)}function d(o){e(o).off("mousedown",i),e(o).off("mousemove",s),e(o).off("dblclick",a)}return void 0===n&&(n={}),n.mouseInput={enable:l,disable:d},n}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(e,o,t,n){"use strict";function r(o){e(o.element).trigger("CornerstoneToolsDragStartActive",o)}function a(a){var i,s,f=a.target.parentNode;switch(a.type){case"pinch":var v=u-a.scale;u=a.scale,c={event:a,viewport:o.getViewport(f),image:o.getEnabledElement(f).image,element:f,direction:0>v?1:-1},i=jQuery.Event("CornerstoneToolsTouchPinch",c),e(f).trigger(i,c);break;case"panstart":l={page:t.point.pageToPoint(a.pointers[0]),image:o.pageToPixel(f,a.pointers[0].pageX,a.pointers[0].pageY),client:{x:a.pointers[0].clientX,y:a.pointers[0].clientY}},c={event:a.srcEvent,viewport:o.getViewport(f),image:o.getEnabledElement(f).image,element:f,startPoints:l,lastPoints:d,currentPoints:l,deltaPoints:{x:0,y:0}},s=1===a.pointers.length?"CornerstoneToolsDragStart":"CornerstoneToolsMultiTouchDragStart",i=jQuery.Event(s,c),e(c.element).trigger(i,c),d=n.copyPoints(l),i.isImmediatePropagationStopped()===!1&&r(c);break;case"panmove":m={page:t.point.pageToPoint(a.pointers[0]),image:o.pageToPixel(f,a.pointers[0].pageX,a.pointers[0].pageY),client:{x:a.pointers[0].clientX,y:a.pointers[0].clientY}},h={page:t.point.subtract(m.page,d.page),image:t.point.subtract(m.image,d.image)},c={viewport:o.getViewport(f),image:o.getEnabledElement(f).image,element:f,startPoints:l,lastPoints:d,currentPoints:m,deltaPoints:h},s=1===a.pointers.length?"CornerstoneToolsTouchDrag":"CornerstoneToolsMultiTouchDrag",i=jQuery.Event(s,c),e(f).trigger(i,c),d=n.copyPoints(m);break;case"panend":var m={page:t.point.pageToPoint(a.pointers[0]),image:o.pageToPixel(f,a.pointers[0].pageX,a.pointers[0].pageY),client:{x:a.pointers[0].clientX,y:a.pointers[0].clientY}},h={page:t.point.subtract(m.page,d.page),image:t.point.subtract(m.image,d.image)};return c={event:a.srcEvent,viewport:o.getViewport(f),image:o.getEnabledElement(f).image,element:f,startPoints:l,lastPoints:d,currentPoints:m,deltaPoints:h},s=1===a.pointers.length?"CornerstoneToolsDragEnd":"CornerstoneToolsMultiTouchDragEnd",i=jQuery.Event(s,c),e(f).trigger(i,c),n.pauseEvent(a);case"rotate":var T=a.rotation-g;g=a.rotation,c={event:a.srcEvent,viewport:o.getViewport(f),image:o.getEnabledElement(f).image,element:f,rotation:T},i=jQuery.Event("CornerstoneToolsTouchRotate",c),e(f).trigger(i,c)}}function i(o){var t={transform_always_block:!0,transform_min_scale:.01,drag_block_horizontal:!0,drag_block_vertical:!0,drag_min_distance:0},n=new Hammer(o);n.set(t);var r={threshold:0,pointers:0,direction:Hammer.DIRECTION_ALL},i=new Hammer.Pan(r),s=new Hammer.Pinch({threshold:.25}),l=new Hammer.Rotate({threshold:.05});s.recognizeWith(i),s.recognizeWith(l),n.add([i,s,l]),n.on("panstart panmove panend pinch rotate",a),e(o).data("hammer",n)}function s(o){var t=e(o).data("hammer");t.off("panstart panmove panend pinch rotate",a)}void 0===n&&(n={});var l,d,c,u=1,g=0;return n.touchInput={enable:i,disable:s},n}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(o){var t={},n={activate:function(t,n,r){e(t).off("CornerstoneToolsMouseDownActivate",o);var a={mouseButtonMask:n,options:r};e(t).on("CornerstoneToolsMouseDownActivate",a,o)},disable:function(t){e(t).off("CornerstoneToolsMouseDownActivate",o)},enable:function(t){e(t).off("CornerstoneToolsMouseDownActivate",o)},deactivate:function(t){e(t).off("CornerstoneToolsMouseDownActivate",o)},getConfiguration:function(){return t},setConfiguration:function(e){t=e}};return n}return void 0===t&&(t={}),t.simpleMouseButtonTool=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t,n){"use strict";function r(r){function a(o){var t=r.createNewMeasurement(o);n.addToolState(o.element,r.toolType,t),e(o.element).off("CornerstoneToolsMouseMove",s),n.moveHandle(o,t.handles.end,function(){t.active=!1,n.anyHandlesOutsideImage(o,t.handles)&&n.removeToolState(o.element,r.toolType,t),e(o.element).on("CornerstoneToolsMouseMove",s)})}function i(e,o){return n.isMouseButtonEnabled(o.which,e.data.mouseButtonMask)?(a(o),!1):void 0}function s(e,t){if(n.toolCoordinates.setCoords(t),0===t.which){var a=n.getToolState(t.element,r.toolType);if(void 0!==a){for(var i=!1,s=0;s<a.data.length;s++){var l=a.data[s];n.handleActivator(l.handles,t.currentPoints.image,t.viewport.scale)===!0&&(i=!0),(r.pointNearTool(l,t.currentPoints.image)&&!l.active||!r.pointNearTool(l,t.currentPoints.image)&&l.active)&&(l.active=!l.active,i=!0)}i===!0&&o.updateImage(t.element)}}}function l(e,o){for(var n in e.handles){var r=t.point.distanceSquared(e.handles[n],o);if(25>r)return e.handles[n]}}function d(t,a){function i(){d.active=!1,n.anyHandlesOutsideImage(a,d.handles)&&n.removeToolState(a.element,r.toolType,d),o.updateImage(a.element),e(a.element).on("CornerstoneToolsMouseMove",s)}var d;if(n.isMouseButtonEnabled(a.which,t.data.mouseButtonMask)){var c,u=a.startPoints.image,g=n.getToolState(t.currentTarget,r.toolType);if(void 0!==g)for(c=0;c<g.data.length;c++){d=g.data[c];var f=l(d,u);if(void 0!==f)return e(a.element).off("CornerstoneToolsMouseMove",s),d.active=!0,n.moveHandle(a,f,i),t.stopImmediatePropagation(),!1}if(void 0!==g&&void 0!==r.pointNearTool)for(c=0;c<g.data.length;c++)if(d=g.data[c],r.pointNearTool(d,u))return e(a.element).off("CornerstoneToolsMouseMove",s),n.moveAllHandles(t,d,g,!0),e(a.element).on("CornerstoneToolsMouseMove",s),t.stopImmediatePropagation(),!1}}function c(t){e(t).off("CornerstoneImageRendered",r.onImageRendered),e(t).off("CornerstoneToolsMouseMove",s),e(t).off("CornerstoneToolsMouseDown",d),e(t).off("CornerstoneToolsMouseDownActivate",i),o.updateImage(t)}function u(t){e(t).off("CornerstoneImageRendered",r.onImageRendered),e(t).off("CornerstoneToolsMouseMove",s),e(t).off("CornerstoneToolsMouseDown",d),e(t).off("CornerstoneToolsMouseDownActivate",i),e(t).on("CornerstoneImageRendered",r.onImageRendered),o.updateImage(t)}function g(t,n){var a={mouseButtonMask:n};e(t).off("CornerstoneImageRendered",r.onImageRendered),e(t).off("CornerstoneToolsMouseMove",s),e(t).off("CornerstoneToolsMouseDown",d),e(t).off("CornerstoneToolsMouseDownActivate",i),e(t).on("CornerstoneImageRendered",r.onImageRendered),e(t).on("CornerstoneToolsMouseMove",a,s),e(t).on("CornerstoneToolsMouseDown",a,d),e(t).on("CornerstoneToolsMouseDownActivate",a,i),o.updateImage(t)}function f(t,n){var a={mouseButtonMask:n};e(t).off("CornerstoneImageRendered",r.onImageRendered),e(t).off("CornerstoneToolsMouseMove",s),e(t).off("CornerstoneToolsMouseDown",d),e(t).off("CornerstoneToolsMouseDownActivate",i),e(t).on("CornerstoneImageRendered",r.onImageRendered),e(t).on("CornerstoneToolsMouseMove",a,s),e(t).on("CornerstoneToolsMouseDown",a,d),o.updateImage(t)}function v(){return h}function m(e){h=e}var h={},T={enable:u,disable:c,activate:g,deactivate:f,getConfiguration:v,setConfiguration:m};return r.pointNearTool&&(T.pointNearTool=r.pointNearTool),T}return void 0===n&&(n={}),n.mouseButtonTool=r,n}($,cornerstone,cornerstoneMath,cornerstoneTools),coordsData,cornerstoneTools=function(e,o,t,n){"use strict";function r(r,a){function i(o){var t=r.createNewMeasurement(o);t&&(n.addToolState(o.element,r.toolType,t),e(o.element).off("CornerstoneToolsMouseMove",l),n.moveHandle(o,t.handles.end,function(){t.active=!1,n.anyHandlesOutsideImage(o,t.handles)&&n.removeToolState(o.element,r.toolType,t),e(o.element).on("CornerstoneToolsMouseMove",l)},a))}function s(e,o){return n.isMouseButtonEnabled(o.which,e.data.mouseButtonMask)?(i(o),!1):void 0}function l(e,t){if(n.toolCoordinates.setCoords(t),0===t.which){var a=n.getToolState(t.element,r.toolType);if(void 0!==a){for(var i=!1,s=0;s<a.data.length;s++){var l=a.data[s];n.handleActivator(l.handles,t.currentPoints.image,t.viewport.scale)===!0&&(i=!0),(r.pointInsideRect(l,t.currentPoints.image)&&!l.active||!r.pointInsideRect(l,t.currentPoints.image)&&l.active)&&(l.active=!l.active,i=!0)}i===!0&&o.updateImage(t.element)}}}function d(e,o){for(var n in e.handles){var r=t.point.distanceSquared(e.handles[n],o);if(25>r)return e.handles[n]}}function c(t,i){function s(){c.active=!1,n.anyHandlesOutsideImage(i,c.handles)&&n.removeToolState(i.element,r.toolType,c),o.updateImage(i.element),e(i.element).on("CornerstoneToolsMouseMove",l)}var c;if(n.isMouseButtonEnabled(i.which,t.data.mouseButtonMask)){var u,g=i.startPoints.image,f=n.getToolState(t.currentTarget,r.toolType);if(void 0!==f)for(u=0;u<f.data.length;u++){c=f.data[u];var v=d(c,g);if(void 0!==v)return e(i.element).off("CornerstoneToolsMouseMove",l),c.active=!0,n.moveHandle(i,v,s,a),t.stopImmediatePropagation(),!1}if(void 0!==f&&void 0!==r.pointInsideRect)for(u=0;u<f.data.length;u++)if(c=f.data[u],r.pointInsideRect(c,g))return e(i.element).off("CornerstoneToolsMouseMove",l),n.moveAllHandles(t,c,f,!1,a),e(i.element).on("CornerstoneToolsMouseMove",l),t.stopImmediatePropagation(),!1}}function u(t){e(t).off("CornerstoneImageRendered",r.onImageRendered),e(t).off("CornerstoneToolsMouseMove",l),e(t).off("CornerstoneToolsMouseDown",c),e(t).off("CornerstoneToolsMouseDownActivate",s),o.updateImage(t)}function g(t){e(t).off("CornerstoneImageRendered",r.onImageRendered),e(t).off("CornerstoneToolsMouseMove",l),e(t).off("CornerstoneToolsMouseDown",c),e(t).off("CornerstoneToolsMouseDownActivate",s),e(t).on("CornerstoneImageRendered",r.onImageRendered),o.updateImage(t)}function f(t,n){var a={mouseButtonMask:n};e(t).off("CornerstoneImageRendered",r.onImageRendered),e(t).off("CornerstoneToolsMouseMove",l),e(t).off("CornerstoneToolsMouseDown",c),e(t).off("CornerstoneToolsMouseDownActivate",s),e(t).on("CornerstoneImageRendered",r.onImageRendered),e(t).on("CornerstoneToolsMouseMove",a,l),e(t).on("CornerstoneToolsMouseDown",a,c),e(t).on("CornerstoneToolsMouseDownActivate",a,s),o.updateImage(t)}function v(t,n){var a={mouseButtonMask:n};e(t).off("CornerstoneImageRendered",r.onImageRendered),e(t).off("CornerstoneToolsMouseMove",l),e(t).off("CornerstoneToolsMouseDown",c),e(t).off("CornerstoneToolsMouseDownActivate",s),e(t).on("CornerstoneImageRendered",r.onImageRendered),e(t).on("CornerstoneToolsMouseMove",a,l),e(t).on("CornerstoneToolsMouseDown",a,c),o.updateImage(t)}var m={enable:g,disable:u,activate:f,deactivate:v};return m}return void 0===n&&(n={}),n.mouseButtonRectangleTool=r,n}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(o){var t={activate:function(t){e(t).off("CornerstoneToolsMouseWheel",o);var n={};e(t).on("CornerstoneToolsMouseWheel",n,o)},disable:function(t){e(t).off("CornerstoneToolsMouseWheel",o)},enable:function(t){e(t).off("CornerstoneToolsMouseWheel",o)},deactivate:function(t){e(t).off("CornerstoneToolsMouseWheel",o)}};return t}return void 0===t&&(t={}),t.mouseWheelTool=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(o){var t={activate:function(t,n){e(t).off("CornerstoneToolsTouchDrag",o);var r={};e(t).on("CornerstoneToolsTouchDrag",r,o)},disable:function(t){e(t).off("CornerstoneToolsTouchDrag",o)},enable:function(t){e(t).off("CornerstoneToolsTouchDrag",o)},deactivate:function(t){e(t).off("CornerstoneToolsTouchDrag",o)}};return t}return void 0===t&&(t={}),t.touchDragTool=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(o){var t={activate:function(t){e(t).off("CornerstoneToolsTouchPinch",o);var n={};e(t).on("CornerstoneToolsTouchPinch",n,o)},disable:function(t){e(t).off("CornerstoneToolsTouchPinch",o)},enable:function(t){e(t).off("CornerstoneToolsTouchPinch",o)},deactivate:function(t){e(t).off("CornerstoneToolsTouchPinch",o)}};return t}return void 0===t&&(t={}),t.touchPinchTool=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t,n){"use strict";function r(r){function a(o){var t=r.createNewMeasurement(o);n.addToolState(o.element,r.toolType,t),e(o.element).off("CornerstoneToolsTouchDrag",s),n.touchMoveHandle(o,t.handles.end,function(){t.active=!1,n.anyHandlesOutsideImage(o,t.handles)&&n.removeToolState(o.element,r.toolType,t),e(o.element).on("CornerstoneToolsTouchDrag",s)})}function i(e,o){return a(o),!1}function s(e,t){n.toolCoordinates.setCoords(t);var a=n.getToolState(t.element,r.toolType);if(void 0!==a){for(var i=!1,s=0;s<a.data.length;s++){var l=a.data[s];n.handleActivator(l.handles,t.currentPoints.image,t.viewport.scale)===!0&&(i=!0)}i===!0&&o.updateImage(t.element)}}function l(e,o){for(var n in e.handles){var r=t.point.distanceSquared(e.handles[n],o);if(30>r)return e.handles[n]}}function d(t,a){function i(){d.active=!1,n.anyHandlesOutsideImage(a,d.handles)&&n.removeToolState(a.element,r.toolType,d),o.updateImage(a.element),e(a.element).on("CornerstoneToolsTouchDrag",s)}var d,c,u=a.startPoints.image,g=n.getToolState(t.currentTarget,r.toolType);if(void 0!==g)for(c=0;c<g.data.length;c++){d=g.data[c];var f=l(d,u);if(void 0!==f)return e(a.element).off("CornerstoneToolsTouchDrag",s),d.active=!0,n.touchMoveHandle(t,f,i),t.stopImmediatePropagation(),!1}if(void 0!==g&&void 0!==r.pointNearTool)for(c=0;c<g.data.length;c++)if(d=g.data[c],r.pointNearTool(d,u))return e(a.element).off("CornerstoneToolsTouchDrag",s),n.touchMoveAllHandles(t,d,g,!0),e(a.element).on("CornerstoneToolsTouchDrag",s),t.stopImmediatePropagation(),!1}function c(t){e(t).off("CornerstoneImageRendered",r.onImageRendered),e(t).off("CornerstoneToolsTouchDrag",s),e(t).off("CornerstoneToolsDragStart",d),e(t).off("CornerstoneToolsDragStartActive",i),o.updateImage(t)}function u(t){e(t).off("CornerstoneImageRendered",r.onImageRendered),e(t).off("CornerstoneToolsTouchDrag",s),e(t).off("CornerstoneToolsDragStart",d),e(t).off("CornerstoneToolsDragStartActive",i),e(t).on("CornerstoneImageRendered",r.onImageRendered),o.updateImage(t)}function g(t){e(t).off("CornerstoneImageRendered",r.onImageRendered),e(t).off("CornerstoneToolsTouchDrag",s),e(t).off("CornerstoneToolsDragStart",d),e(t).off("CornerstoneToolsDragStartActive",i),e(t).on("CornerstoneImageRendered",r.onImageRendered),e(t).on("CornerstoneToolsTouchDrag",s),e(t).on("CornerstoneToolsDragStart",d),e(t).on("CornerstoneToolsDragStartActive",i),o.updateImage(t)}function f(t){e(t).off("CornerstoneImageRendered",r.onImageRendered),e(t).off("CornerstoneToolsTouchDrag",s),e(t).off("CornerstoneToolsDragStart",d),e(t).off("CornerstoneToolsDragStartActive",i),e(t).on("CornerstoneImageRendered",r.onImageRendered),e(t).on("CornerstoneToolsTouchDrag",s),e(t).on("CornerstoneToolsDragStart",d),o.updateImage(t)}var v={enable:u,disable:c,activate:g,deactivate:f};return v}return void 0===n&&(n={}),n.touchTool=r,n}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(e,o,t,n){"use strict";function r(e){var o={visible:!0,active:!0,handles:{start:{x:e.currentPoints.image.x-20,y:e.currentPoints.image.y+10,highlight:!0,active:!1},end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0},start2:{x:e.currentPoints.image.x-20,y:e.currentPoints.image.y+10,highlight:!0,active:!1},end2:{x:e.currentPoints.image.x,y:e.currentPoints.image.y+20,highlight:!0,active:!1}}};return o}function a(e,o){var n={start:e.handles.start,end:e.handles.end},r=t.lineSegment.distanceToPoint(n,o);return 5>r?!0:(n.start=e.handles.start2,n.end=e.handles.end2,r=t.lineSegment.distanceToPoint(n,o),5>r)}function i(e,t){var r=n.getToolState(e.currentTarget,s);if(void 0!==r){var a=t.canvasContext.canvas.getContext("2d");a.setTransform(1,0,0,1,0,0);for(var i,l=n.toolStyle.getToolWidth(),d=n.textStyle.getFont(),c=0;c<r.data.length;c++){a.save();var u=r.data[c];i=u.active?n.toolColors.getActiveColor():n.toolColors.getToolColor(),a.beginPath(),a.strokeStyle=i,a.lineWidth=l;var g=o.pixelToCanvas(t.element,u.handles.start),f=o.pixelToCanvas(t.element,u.handles.end);a.moveTo(g.x,g.y),a.lineTo(f.x,f.y),g=o.pixelToCanvas(t.element,u.handles.start2),f=o.pixelToCanvas(t.element,u.handles.end2),a.moveTo(g.x,g.y),a.lineTo(f.x,f.y),a.stroke(),n.drawHandles(a,t,u.handles),a.fillStyle=i;var v=(Math.ceil(u.handles.start.x)-Math.ceil(u.handles.end.x))*t.image.columnPixelSpacing,m=(Math.ceil(u.handles.start.y)-Math.ceil(u.handles.end.y))*t.image.rowPixelSpacing,h=(Math.ceil(u.handles.start2.x)-Math.ceil(u.handles.end2.x))*t.image.columnPixelSpacing,T=(Math.ceil(u.handles.start2.y)-Math.ceil(u.handles.end2.y))*t.image.rowPixelSpacing,p=Math.acos(Math.abs((v*h+m*T)/(Math.sqrt(v*v+m*m)*Math.sqrt(h*h+T*T))));p*=180/Math.PI;var C=n.roundToDecimal(p,2),M="00B0",x=C.toString()+String.fromCharCode(parseInt(M,16)),y=(g.x+f.x)/2,w=(g.y+f.y)/2;a.font=d,n.drawTextBox(a,x,y,w,i),a.restore()}}}void 0===n&&(n={});var s="angle";return n.angle=n.mouseButtonTool({createNewMeasurement:r,onImageRendered:i,pointNearTool:a,toolType:s}),n.angleTouch=n.touchTool({createNewMeasurement:r,onImageRendered:i,pointNearTool:a,toolType:s}),n}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(e,o,t,n){"use strict";function r(e){e(prompt("Enter your annotation:"))}function a(t){function r(e){null!==e?a.annotationText=e:n.removeToolState(t.element,k,a),o.updateImage(t.element)}var a=c(t);n.addToolState(t.element,k,a),e(t.element).off("CornerstoneToolsMouseMove",s),n.moveHandle(t,a.handles.end,function(){a.active=!1,n.anyHandlesOutsideImage(t,a.handles)&&n.removeToolState(t.element,k,a);var o=n.arrowAnnotate.getConfiguration();void 0===a.annotationText&&o.getTextCallback(r),e(t.element).on("CornerstoneToolsMouseMove",s)})}function i(e,o){return n.isMouseButtonEnabled(o.which,e.data.mouseButtonMask)?(a(o),!1):void 0}function s(e,t){if(n.toolCoordinates.setCoords(t),0===t.which){var r=n.getToolState(t.element,k);if(void 0!==r){for(var a=!1,i=0;i<r.data.length;i++){var s=r.data[i];n.handleActivator(s.handles,t.currentPoints.image,t.viewport.scale)===!0&&(a=!0),(u(s,t.currentPoints.image)&&!s.active||!u(s,t.currentPoints.image)&&s.active)&&(s.active=!s.active,a=!0)}return a===!0&&o.updateImage(t.element),!1}}}function l(e,o){for(var n in e.handles){var r=t.point.distanceSquared(e.handles[n],o);if(25>r)return e.handles[n]}}function d(t,r){function a(){i.active=!1,n.anyHandlesOutsideImage(r,i.handles)&&n.removeToolState(r.element,k,i),o.updateImage(r.element),e(r.element).on("CornerstoneToolsMouseMove",s)}var i;if(n.isMouseButtonEnabled(r.which,t.data.mouseButtonMask)){var d,c=r.startPoints.image,g=n.getToolState(t.currentTarget,k);if(void 0!==g)for(d=0;d<g.data.length;d++){i=g.data[d];var f=l(i,c);if(void 0!==f)return e(r.element).off("CornerstoneToolsMouseMove",s),i.active=!0,n.moveHandle(r,f,a),t.stopImmediatePropagation(),!1}if(void 0!==g&&void 0!==u)for(d=0;d<g.data.length;d++)if(i=g.data[d],u(i,c))return e(r.element).off("CornerstoneToolsMouseMove",s),n.moveAllHandles(t,i,g,!0),e(r.element).on("CornerstoneToolsMouseMove",s),t.stopImmediatePropagation(),!1;return!1}}function c(e){var o={visible:!0,active:!0,handles:{start:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!1},end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0}}};return o}function u(e,o){var n={start:e.handles.start,end:e.handles.end},r=t.lineSegment.distanceToPoint(n,o);return 25>r}function g(e,o,t,n,r){var a=10,i=Math.atan2(t.y-o.y,t.x-o.x);e.beginPath(),e.moveTo(o.x,o.y),e.lineTo(t.x,t.y),e.strokeStyle=n,e.lineWidth=r,e.stroke(),e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(t.x-a*Math.cos(i-Math.PI/7),t.y-a*Math.sin(i-Math.PI/7)),e.lineTo(t.x-a*Math.cos(i+Math.PI/7),t.y-a*Math.sin(i+Math.PI/7)),e.lineTo(t.x,t.y),e.lineTo(t.x-a*Math.cos(i-Math.PI/7),t.y-a*Math.sin(i-Math.PI/7)),e.strokeStyle=n,e.lineWidth=r,e.stroke(),e.fillStyle=n,e.fill()}function f(e,t){var r=n.getToolState(e.currentTarget,k);if(void 0!==r){var a=n.arrowAnnotate.getConfiguration(),i=t.canvasContext.canvas.getContext("2d");i.setTransform(1,0,0,1,0,0);for(var s,l=n.toolStyle.getToolWidth(),d=n.textStyle.getFont(),c=(n.textStyle.getFontSize(),0);c<r.data.length;c++){i.save();var u=r.data[c];s=u.active?n.toolColors.getActiveColor():n.toolColors.getToolColor();var f=o.pixelToCanvas(t.element,u.handles.start),v=o.pixelToCanvas(t.element,u.handles.end);if(a.arrowFirst?g(i,v,f,s,l):g(i,f,v,s,l),a.drawHandles!==!1&&n.drawHandles(i,t,u.handles,s),u.annotationText&&""!==u.annotationText){i.font=d;var m,h=13,T={x:h,y:h/2};m={x:v.x-f.x,y:v.y-f.y};var p;a.arrowFirst?(m.x<0&&(T.x=-T.x-i.measureText(u.annotationText).width),p={x:m.x+f.x+T.x,y:m.y+f.y+T.y}):(m.x>0&&(T.x=-T.x-i.measureText(u.annotationText).width),p={x:-m.x+v.x+T.x,y:-m.y+v.y+T.y}),n.drawTextBox(i,u.annotationText,p.x,p.y,s)}i.restore()}}}function v(t){e(t).off("CornerstoneImageRendered",f),e(t).off("CornerstoneToolsMouseMove",s),e(t).off("CornerstoneToolsMouseDown",d),e(t).off("CornerstoneToolsMouseDownActivate",i),o.updateImage(t)}function m(t){e(t).off("CornerstoneImageRendered",f),e(t).off("CornerstoneToolsMouseMove",s),e(t).off("CornerstoneToolsMouseDown",d),e(t).off("CornerstoneToolsMouseDownActivate",i),e(t).on("CornerstoneImageRendered",f),o.updateImage(t)}function h(t,n){var r={mouseButtonMask:n};e(t).off("CornerstoneImageRendered",f),e(t).off("CornerstoneToolsMouseMove",s),e(t).off("CornerstoneToolsMouseDown",d),e(t).off("CornerstoneToolsMouseDownActivate",i),e(t).on("CornerstoneImageRendered",f),e(t).on("CornerstoneToolsMouseMove",r,s),e(t).on("CornerstoneToolsMouseDown",r,d),e(t).on("CornerstoneToolsMouseDownActivate",r,i),o.updateImage(t)}function T(t,n){var r={mouseButtonMask:n};e(t).off("CornerstoneImageRendered",f),e(t).off("CornerstoneToolsMouseMove",s),e(t).off("CornerstoneToolsMouseDown",d),e(t).off("CornerstoneToolsMouseDownActivate",i),e(t).on("CornerstoneImageRendered",f),e(t).on("CornerstoneToolsMouseMove",r,s),e(t).on("CornerstoneToolsMouseDown",r,d),o.updateImage(t)}function p(t){function r(e){null!==e?a.annotationText=e:n.removeToolState(t.element,k,a),o.updateImage(t.element)}var a=c(t);n.addToolState(t.element,k,a),e(t.element).off("CornerstoneToolsTouchDrag",M),n.touchMoveHandle(t,a.handles.end,function(){n.anyHandlesOutsideImage(t,a.handles)&&n.removeToolState(t.element,k,a);var o=n.arrowAnnotate.getConfiguration();void 0===a.annotationText&&o.getTextCallback(r),e(t.element).on("CornerstoneToolsTouchDrag",M)})}function C(e,o){return p(o),!1}function M(e,t){n.toolCoordinates.setCoords(t);var r=n.getToolState(t.element,k);if(void 0!==r){for(var a=!1,i=0;i<r.data.length;i++){var s=r.data[i];n.handleActivator(s.handles,t.currentPoints.image,t.viewport.scale)===!0&&(a=!0)}return a===!0&&o.updateImage(t.element),!1}}function x(e,o){for(var n in e.handles){var r=t.point.distanceSquared(e.handles[n],o);if(30>r)return e.handles[n]}}function y(o,t){function r(){n.anyHandlesOutsideImage(t,a.handles)&&n.removeToolState(t.element,k,a),e(t.element).on("CornerstoneToolsTouchDrag",M)}var a,i,s=t.startPoints.image,l=n.getToolState(o.currentTarget,k);if(void 0!==l)for(i=0;i<l.data.length;i++){a=l.data[i];var d=x(a,s);if(void 0!==d)return e(t.element).off("CornerstoneToolsTouchDrag",M),n.touchMoveHandle(t,d,r),o.stopImmediatePropagation(),!1}if(void 0!==l&&void 0!==u)for(i=0;i<l.data.length;i++)if(a=l.data[i],u(a,s))return e(t.element).off("CornerstoneToolsTouchDrag",M),n.touchMoveAllHandles(o,a,l,!0),o.stopImmediatePropagation(),!1;return!1}function w(t){e(t).off("CornerstoneImageRendered",f),e(t).off("CornerstoneToolsTouchDrag",M),e(t).off("CornerstoneToolsDragStart",y),e(t).off("CornerstoneToolsDragStartActive",C),o.updateImage(t)}function I(t){e(t).off("CornerstoneImageRendered",f),e(t).off("CornerstoneToolsTouchDrag",M),e(t).off("CornerstoneToolsDragStart",y),e(t).off("CornerstoneToolsDragStartActive",C),e(t).on("CornerstoneImageRendered",f),o.updateImage(t)}function S(t){e(t).off("CornerstoneImageRendered",f),e(t).off("CornerstoneToolsTouchDrag",M),e(t).off("CornerstoneToolsDragStart",y),e(t).off("CornerstoneToolsDragStartActive",C),e(t).on("CornerstoneImageRendered",f),e(t).on("CornerstoneToolsTouchDrag",M),e(t).on("CornerstoneToolsDragStart",y),e(t).on("CornerstoneToolsDragStartActive",C),o.updateImage(t)}function P(t){e(t).off("CornerstoneImageRendered",f),e(t).off("CornerstoneToolsTouchDrag",M),e(t).off("CornerstoneToolsDragStart",y),e(t).off("CornerstoneToolsDragStartActive",C),e(t).on("CornerstoneImageRendered",f),e(t).on("CornerstoneToolsTouchDrag",M),e(t).on("CornerstoneToolsDragStart",y),o.updateImage(t)}function D(){return E}function b(e){E=e}void 0===n&&(n={});var k="arrowAnnotate",E={getTextCallback:r,drawHandles:!1,arrowFirst:!0};return n.arrowAnnotate={enable:m,disable:v,activate:h,deactivate:T,getConfiguration:D,setConfiguration:b,pointNearTool:u},n.arrowAnnotateTouch={enable:I,disable:w,activate:S,deactivate:P},n}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(n,r){var a=t.getToolState(n.currentTarget,d);if(void 0!==a){var i=n.currentTarget,s=o.getEnabledElement(i),l=s.image.imageId,c=t.metaData.get("imagePlane",l),u=r.currentPoints.image,g=t.imagePointToPatientPoint(u,c),f=a.data[0].synchronizationContext,v=f.getSourceElements();e.each(v,function(n,r){if(r!==i){var a=Number.MAX_VALUE,s=-1,l=t.getToolState(r,"stack");if(void 0!==l){var d=l.data[0];if(e.each(d.imageIds,function(e,o){var n=t.metaData.get("imagePlane",o),r=n.imagePositionPatient,i=n.rowCosines.clone(),l=n.columnCosines.clone(),d=l.clone().cross(i.clone()),c=Math.abs(d.clone().dot(r)-d.clone().dot(g));a>c&&(a=c,s=e)}),s!==d.currentImageIdIndex&&-1!==s&&void 0!==d.imageIds[s]){var c=t.loadHandlerManager.getStartLoadHandler(),u=t.loadHandlerManager.getEndLoadHandler();c&&c(element),o.loadAndCacheImage(d.imageIds[s]).then(function(e){var t=o.getViewport(r);d.currentImageIdIndex=s,o.displayImage(r,e,t),u&&u(element)})}}}})}}function r(o,t){e(t.element).off("CornerstoneToolsMouseDrag",i),e(t.element).off("CornerstoneToolsMouseUp",r)}function a(o,a){return t.isMouseButtonEnabled(a.which,o.data.mouseButtonMask)?(e(a.element).on("CornerstoneToolsMouseDrag",i),e(a.element).on("CornerstoneToolsMouseUp",r),n(o,a),!1):void 0}function i(e,o){return n(e,o),!1}function s(o,n,r){var i={mouseButtonMask:n};t.addToolState(o,d,{synchronizationContext:r}),e(o).off("CornerstoneToolsMouseDown",a),e(o).on("CornerstoneToolsMouseDown",i,a)}function l(o,t){e(o).off("CornerstoneToolsMouseDown",a)}void 0===t&&(t={});var d="crosshairs";return t.crosshairs={enable:s,disable:l},t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e){{var n=o.getEnabledElement(e.element);n.image}o.updateImage(e.element);var r=n.canvas.getContext("2d");r.setTransform(1,0,0,1,0,0);var a=t.toolColors.getActiveColor(),i=t.textStyle.getFont(),s=t.textStyle.getFontSize();r.save();var l=Math.round(e.currentPoints.image.x),d=Math.round(e.currentPoints.image.y),c=o.getStoredPixels(e.element,l,d,1,1),u=c[0],g=u*e.image.slope+e.image.intercept,f=t.calculateSUV(e.image,u),v={x:e.currentPoints.image.x+3,y:e.currentPoints.image.y-3},m=o.pixelToCanvas(e.element,v);r.font=i,r.fillStyle=a;var h=""+l+","+d,T="SP: "+u+" MO: "+parseFloat(g.toFixed(3));f&&(T+=" SUV: "+parseFloat(f.toFixed(3))),t.drawTextBox(r,T,m.x,m.y+s+5,a),t.drawTextBox(r,h,m.x,m.y,a),r.restore()}function r(e){{var n=o.getEnabledElement(e.element);n.image}o.updateImage(e.element);var r=n.canvas.getContext("2d");r.setTransform(1,0,0,1,0,0);{var a=t.toolColors.getActiveColor(),i=t.textStyle.getFont();t.textStyle.getFontSize()}r.save();var s=Math.round(e.currentPoints.image.x),l=Math.round(e.currentPoints.image.y),d=o.getStoredPixels(e.element,s,l,1,1),c=parseFloat(d[0].toFixed(3)),u={x:e.currentPoints.image.x+4,y:e.currentPoints.image.y-4},g=o.pixelToCanvas(e.element,u);r.font=i,r.fillStyle=a,t.drawTextBox(r,c,g.x,g.y,a),r.restore()}function a(t,n){e(n.element).off("CornerstoneToolsMouseDrag",s),e(n.element).off("CornerstoneToolsMouseUp",a),o.updateImage(n.element)}function i(o,n){return t.isMouseButtonEnabled(n.which,o.data.mouseButtonMask)?(e(n.element).on("CornerstoneToolsMouseDrag",s),e(n.element).on("CornerstoneToolsMouseUp",a),t.dragProbe.strategy(n),!1):void 0}function s(e,o){return t.dragProbe.strategy(o),!1}return void 0===t&&(t={}),t.dragProbe=t.simpleMouseButtonTool(i),t.dragProbe.strategies={"default":n,minimal:r},t.dragProbe.strategy=n,t.dragProbeTouch=t.touchDragTool(s),t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t,n){"use strict";function r(e){var o={visible:!0,active:!0,handles:{start:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!1},end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,
active:!0}}};return o}function a(e,o){var n={left:Math.min(e.handles.start.x,e.handles.end.x),top:Math.min(e.handles.start.y,e.handles.end.y),width:Math.abs(e.handles.start.x-e.handles.end.x),height:Math.abs(e.handles.start.y-e.handles.end.y)},r=t.rect.distanceToPoint(n,o);return 5>r}function i(e,o){var t=e.width/2,n=e.height/2;if(0>=t||0>=n)return!1;var r={x:e.left+t,y:e.top+n},a={x:o.x-r.x,y:o.y-r.y},i=a.x*a.y/(t*t)+a.y*a.y/(n*n)<=1;return i}function s(e,o){for(var t=0,n=0,r=0,a=0,s=o.top;s<o.top+o.height;s++)for(var l=o.left;l<o.left+o.width;l++)i(o,{x:l,y:s})===!0&&(t+=e[a],n+=e[a]*e[a],r++),a++;if(0===r)return{count:r,mean:0,variance:0,stdDev:0};var d=t/r,c=n/r-d*d;return{count:r,mean:d,variance:c,stdDev:Math.sqrt(c)}}function l(e,t){var r=n.getToolState(e.currentTarget,d);if(void 0!==r){var a=t.canvasContext.canvas.getContext("2d");a.setTransform(1,0,0,1,0,0);for(var i,l=n.toolStyle.getToolWidth(),c=n.textStyle.getFont(),u=n.textStyle.getFontSize(),g=0;g<r.data.length;g++){a.save();var f=r.data[g];i=f.active?n.toolColors.getActiveColor():n.toolColors.getToolColor();var v=o.pixelToCanvas(t.element,f.handles.start),m=o.pixelToCanvas(t.element,f.handles.end),h=Math.abs(v.x-m.x),T=Math.abs(v.y-m.y),p=Math.min(v.x,m.x),C=Math.min(v.y,m.y),M=(v.x+m.x)/2,x=(v.y+m.y)/2;a.beginPath(),a.strokeStyle=i,a.lineWidth=l,n.drawEllipse(a,p,C,h,T),a.closePath(),n.drawHandles(a,t,f.handles);var y=Math.abs(f.handles.start.x-f.handles.end.x),w=Math.abs(f.handles.start.y-f.handles.end.y),I=Math.min(f.handles.start.x,f.handles.end.x),S=Math.min(f.handles.start.y,f.handles.end.y),P=o.getPixels(t.element,I,S,y,w),D={left:I,top:S,width:y,height:w},b=s(P,D),k=Math.PI*(y*t.image.columnPixelSpacing/2)*(w*t.image.rowPixelSpacing/2),E="Area: "+k.toFixed(2)+" mm^2";a.font=c;var R=a.measureText(k),A=M<t.image.columns/2?M+h/2:M-h/2-R.width,B=x<t.image.rows/2?x+T/2:x-T/2;a.fillStyle=i,n.drawTextBox(a,"Mean: "+b.mean.toFixed(2),A,B-u-5,i),n.drawTextBox(a,"StdDev: "+b.stdDev.toFixed(2),A,B,i),n.drawTextBox(a,E,A,B+u+5,i),a.restore()}}}void 0===n&&(n={});var d="ellipticalRoi";return n.ellipticalRoi=n.mouseButtonTool({createNewMeasurement:r,onImageRendered:l,pointNearTool:a,toolType:d}),n.ellipticalRoiTouch=n.touchTool({createNewMeasurement:r,onImageRendered:l,pointNearTool:a,toolType:d}),n}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(e,o,t,n){"use strict";function r(e){var t=n.getToolState(e.element,C);if(void 0!==t){var r=n.freehand.getConfiguration(),a=t.data[r.currentTool],i={x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0,lines:[]};a.handles.length&&a.handles[r.currentHandle-1].lines.push(e.currentPoints.image),a.handles.push(i),r.currentHandle+=1,r.freehand=!1,o.updateImage(e.element)}}function a(e,o){var r=n.getToolState(e.element,C);if(void 0!==r){var a=r.data[o];if(void 0!==a.handles)for(var i=e.currentPoints.image,s=0;s<a.handles.length;s++)if(t.point.distance(a.handles[s],i)<5)return s}}function i(e){var o=n.getToolState(e.element,C);if(void 0!==o)for(var t,r=0;r<o.data.length;r++)if(t=a(e,r),void 0!==t)return{handleNearby:t,toolIndex:r}}function s(t,r){e(r.element).off("CornerstoneToolsMouseUp",s);var a=n.getToolState(r.element,C);if(void 0!==a){var i=n.freehand.getConfiguration();r.event.shiftKey||(i.freehand=!1),o.updateImage(r.element)}}function l(e,t){var r=n.getToolState(t.element,C);if(void 0!==r){var i=n.freehand.getConfiguration(),s=r.data[i.currentTool];i.mouseLocation.handles.start.x=t.currentPoints.image.x,i.mouseLocation.handles.start.y=t.currentPoints.image.y;var l=i.currentHandle;if(i.modifying&&(s.active=!0,s.highlight=!0,s.handles[l].x=i.mouseLocation.handles.start.x,s.handles[l].y=i.mouseLocation.handles.start.y,l)){var d=s.handles[l-1].lines.length-1,c=s.handles[l-1].lines[d];c.x=i.mouseLocation.handles.start.x,c.y=i.mouseLocation.handles.start.y}if(i.freehand)s.handles[l-1].lines.push(t.currentPoints.image);else{var u=a(t,i.currentTool);void 0!==u&&u<s.handles.length-1&&(i.mouseLocation.handles.start.x=s.handles[u].x,i.mouseLocation.handles.start.y=s.handles[u].y)}o.updateImage(t.element)}}function d(o){e(o.element).on("CornerstoneToolsMouseMove",l),e(o.element).on("CornerstoneToolsMouseUp",s);var t={visible:!0,active:!0,handles:[]},r=n.freehand.getConfiguration();r.mouseLocation.handles.start.x=o.currentPoints.image.x,r.mouseLocation.handles.start.y=o.currentPoints.image.y,n.addToolState(o.element,C,t);var a=n.getToolState(o.element,C);r.currentTool=a.data.length-1}function c(t,r){var a=n.getToolState(t.element,C);if(void 0!==a){var i=n.freehand.getConfiguration(),s=a.data[i.currentTool];s.active=!1,s.highlight=!1,void 0!==r&&s.handles[i.currentHandle-1].lines.push(s.handles[r]),i.modifying&&(i.modifying=!1),i.currentHandle=0,i.currentTool=-1,e(t.element).off("CornerstoneToolsMouseMove",l),o.updateImage(t.element)}}function u(o,t){if(n.isMouseButtonEnabled(t.which,o.data.mouseButtonMask)){var u,g,f=n.getToolState(t.element,C),v=n.freehand.getConfiguration(),m=v.currentTool;if(v.modifying)return void c(t);if(0>m){var h=i(t);h?(u=h.handleNearby,g=h.toolIndex,void 0!==u&&(e(t.element).on("CornerstoneToolsMouseMove",l),e(t.element).on("CornerstoneToolsMouseUp",s),v.modifying=!0,v.currentHandle=u,v.currentTool=g)):(d(t),r(t))}else m>=0&&f.data[m].active&&(u=a(t,m),void 0!==u?c(t,u):t.event.shiftKey?v.freehand=!0:r(t));return!1}}function g(e,t){var r=n.getToolState(e.currentTarget,C);if(void 0!==r){var a=n.freehand.getConfiguration(),i=t.canvasContext.canvas.getContext("2d");i.setTransform(1,0,0,1,0,0);for(var s,l=n.toolStyle.getToolWidth(),d=n.toolColors.getFillColor(),c=0;c<r.data.length;c++){i.save();var u=r.data[c];u.active?(s=n.toolColors.getActiveColor(),d=n.toolColors.getFillColor()):(s=n.toolColors.getToolColor(),d=n.toolColors.getToolColor());var g;if(u.handles.length)for(var f=0;f<u.handles.length;f++){g=u.handles[f];var v=o.pixelToCanvas(t.element,g);i.beginPath(),i.strokeStyle=s,i.lineWidth=l,i.moveTo(v.x,v.y);for(var m=0;m<u.handles[f].lines.length;m++){var h=o.pixelToCanvas(t.element,u.handles[f].lines[m]);i.lineTo(h.x,h.y),i.stroke()}var T=o.pixelToCanvas(t.element,a.mouseLocation.handles.start);f===u.handles.length-1&&(!u.active||a.freehand||a.modifying||(i.lineTo(T.x,T.y),i.stroke()))}u.active&&n.drawHandles(i,t,a.mouseLocation.handles,s,d),n.drawHandles(i,t,u.handles,s,d),i.restore()}}}function f(t){e(t).off("CornerstoneToolsMouseDown",u),e(t).off("CornerstoneToolsMouseUp",s),e(t).off("CornerstoneToolsMouseMove",l),e(t).off("CornerstoneImageRendered",g),e(t).on("CornerstoneImageRendered",g),o.updateImage(t)}function v(t){e(t).off("CornerstoneToolsMouseDown",u),e(t).off("CornerstoneToolsMouseUp",s),e(t).off("CornerstoneToolsMouseMove",l),e(t).off("CornerstoneImageRendered",g),o.updateImage(t)}function m(t,n){var r={mouseButtonMask:n};e(t).off("CornerstoneToolsMouseDown",u),e(t).off("CornerstoneToolsMouseUp",s),e(t).off("CornerstoneToolsMouseMove",l),e(t).off("CornerstoneImageRendered",g),e(t).on("CornerstoneImageRendered",g),e(t).on("CornerstoneToolsMouseDown",r,u),o.updateImage(t)}function h(t,n){e(t).off("CornerstoneToolsMouseDown",u),e(t).off("CornerstoneToolsMouseUp",s),e(t).off("CornerstoneToolsMouseMove",l),e(t).off("CornerstoneImageRendered",g),e(t).on("CornerstoneImageRendered",g),o.updateImage(t)}function T(){return M}function p(e){M=e}void 0===n&&(n={});var C="freehand",M={mouseLocation:{handles:{start:{highlight:!0,active:!0}}},freehand:!1,modifying:!1,currentHandle:0,currentTool:-1};return n.freehand={enable:f,disable:v,activate:m,deactivate:h,getConfiguration:T,setConfiguration:p},n}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(e,o,t,n){"use strict";function r(e){var o=n.getToolState(e.event.currentTarget,l);if(!(o&&o.data&&o.data.length>0)){var t={visible:!0,active:!0,handles:{start:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!1},end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0}}};return t}}function a(e,o){var t={left:Math.min(e.handles.start.x,e.handles.end.x),top:Math.min(e.handles.start.y,e.handles.end.y),width:Math.abs(e.handles.start.x-e.handles.end.x),height:Math.abs(e.handles.start.y-e.handles.end.y)},n=!1;return o.x>=t.left&&o.x<=t.left+t.width&&o.y>=t.top&&o.y<=t.top+t.height&&(n=!0),n}function i(e,o){var n={left:Math.min(e.handles.start.x,e.handles.end.x),top:Math.min(e.handles.start.y,e.handles.end.y),width:Math.abs(e.handles.start.x-e.handles.end.x),height:Math.abs(e.handles.start.y-e.handles.end.y)},r=t.rect.distanceToPoint(n,o);return 5>r}function s(e,t){var r=n.getToolState(e.currentTarget,l);if(void 0!==r){var a=t.canvasContext.canvas.getContext("2d");a.setTransform(1,0,0,1,0,0);var i,s=n.toolStyle.getToolWidth();a.save();var d=r.data[0];if(d){i=d.active?n.toolColors.getActiveColor():n.toolColors.getToolColor();var c=o.pixelToCanvas(t.element,d.handles.start),u=o.pixelToCanvas(t.element,d.handles.end),g={left:Math.min(c.x,u.x),top:Math.min(c.y,u.y),width:Math.abs(c.x-u.x),height:Math.abs(c.y-u.y)};a.beginPath(),a.strokeStyle="transparent",a.rect(0,0,a.canvas.clientWidth,a.canvas.clientHeight),a.rect(g.width+g.left,g.top,-g.width,g.height),a.stroke(),a.fillStyle="rgba(0,0,0,0.7)",a.fill(),a.closePath(),a.beginPath(),a.strokeStyle=i,a.lineWidth=s,a.setLineDash([4]),a.strokeRect(g.left,g.top,g.width,g.height),a.setLineDash([]),n.drawHandles(a,t,d.handles,i),a.restore()}}}void 0===n&&(n={});var l="highlight",d=!0;return n.highlight=n.mouseButtonRectangleTool({createNewMeasurement:r,onImageRendered:s,pointNearTool:i,pointInsideRect:a,toolType:l},d),n.highlightTouch=n.touchTool({createNewMeasurement:r,onImageRendered:s,pointNearTool:i,pointInsideRect:a,toolType:l},d),n}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(o){var t={},n={activate:function(t){e(t).off("CornerstoneToolsKeyDown",o),e(t).on("CornerstoneToolsKeyDown",o)},disable:function(t){e(t).off("CornerstoneToolsKeyDown",o)},enable:function(t){e(t).off("CornerstoneToolsKeyDown",o)},deactivate:function(t){e(t).off("CornerstoneToolsKeyDown",o)},getConfiguration:function(){return t},setConfiguration:function(e){t=e}};return n}return void 0===t&&(t={}),t.keyboardTool=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t,n){"use strict";function r(e){var o={visible:!0,active:!0,handles:{start:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!1},end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0}}};return o}function a(e,o){var n={start:e.handles.start,end:e.handles.end},r=t.lineSegment.distanceToPoint(n,o);return 25>r}function i(e,t){var r=n.getToolState(e.currentTarget,s);if(void 0!==r){var a=t.canvasContext.canvas.getContext("2d");a.setTransform(1,0,0,1,0,0);for(var i,l=n.toolStyle.getToolWidth(),d=n.textStyle.getFont(),c=0;c<r.data.length;c++){a.save();var u=r.data[c];i=u.active?n.toolColors.getActiveColor():n.toolColors.getToolColor();var g=o.pixelToCanvas(t.element,u.handles.start),f=o.pixelToCanvas(t.element,u.handles.end);a.beginPath(),a.strokeStyle=i,a.lineWidth=l,a.moveTo(g.x,g.y),a.lineTo(f.x,f.y),a.stroke(),n.drawHandles(a,t,u.handles,i),a.fillStyle=i;var v=(u.handles.start.x-u.handles.end.x)*t.image.columnPixelSpacing,m=(u.handles.start.y-u.handles.end.y)*t.image.rowPixelSpacing,h=Math.sqrt(v*v+m*m),T=""+h.toFixed(2)+" mm";a.font=d;var p={x:(g.x+f.x)/2+5,y:(g.y+f.y)/2};n.drawTextBox(a,T,p.x,p.y,i),a.restore()}}}void 0===n&&(n={});var s="length";return n.length=n.mouseButtonTool({createNewMeasurement:r,onImageRendered:i,pointNearTool:a,toolType:s}),n.lengthTouch=n.touchTool({createNewMeasurement:r,onImageRendered:i,pointNearTool:a,toolType:s}),n}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(o,t){e(t.element).off("CornerstoneToolsMouseDrag",i),e(t.element).off("CornerstoneToolsMouseUp",n),r(t)}function r(o){e(o.element).find(".magnifyTool").hide(),document.body.style.cursor="default"}function a(o,r){return t.isMouseButtonEnabled(r.which,o.data.mouseButtonMask)?(e(r.element).on("CornerstoneToolsMouseDrag",r,i),e(r.element).on("CornerstoneToolsMouseUp",r,n),s(r),!1):void 0}function i(e,o){return s(o),!1}function s(n){var r=e(n.element).find(".magnifyTool").get(0);void 0===r&&l(n.element);var a=o.getEnabledElement(n.element),i=(a.image,t.magnify.getConfiguration()),s=i.magnifySize,d=i.magnificationLevel,c=e(n.element).find("canvas").not(".magnifyTool").get(0),u=c.getContext("2d");u.setTransform(1,0,0,1,0,0);var g=r.getContext("2d");g.setTransform(1,0,0,1,0,0);var f=o.pixelToCanvas(n.element,n.currentPoints.image);f.x=Math.max(f.x,0),f.x=Math.min(f.x,c.width),f.y=Math.max(f.y,0),f.y=Math.min(f.y,c.height),g.clearRect(0,0,s,s),g.fillStyle="transparent",g.fillRect(0,0,s,s);var v=s*d,m=s/d,h={x:f.x-.5*m,y:f.y-.5*m};g.drawImage(c,h.x,h.y,s,s,0,0,v,v),r.style.top=f.y-.5*s+"px",r.style.left=f.x-.5*s+"px",r.style.display="block",document.body.style.cursor="none"}function l(o){if(0===e(o).find(".magnifyTool").length){var n=document.createElement("canvas");n.classList.add("magnifyTool");var r=t.magnify.getConfiguration();n.width=r.magnifySize,n.height=r.magnifySize,n.style.position="absolute",o.appendChild(n)}}function d(o){e(o).find(".magnifyTool").remove()}function c(o){e(o).off("CornerstoneToolsMouseDown",a),d(o)}function u(e){var o=t.magnify.getConfiguration(o);l(e)}function g(o,t){var n={mouseButtonMask:t};e(o).off("CornerstoneToolsMouseDown",a),e(o).on("CornerstoneToolsMouseDown",n,a),l(o)}function f(o){e(o).off("CornerstoneToolsTouchDrag",i),e(o).off("CornerstoneToolsDragStart",i),d(o)}function v(o){e(o).off("CornerstoneToolsTouchDrag",i),e(o).off("CornerstoneToolsDragStart",i),e(o).on("CornerstoneToolsTouchDrag",i),e(o).on("CornerstoneToolsDragStart",i),l(o)}function m(){return T}function h(e){T=e}void 0===t&&(t={});var T={magnifySize:100,magnificationLevel:2};return t.magnify={enable:u,activate:g,deactivate:c,disable:c,getConfiguration:m,setConfiguration:h},t.magnifyTouchDrag={enable:u,activate:v,deactivate:f,disable:f},t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(o,t){e(t.element).off("CornerstoneToolsMouseDrag",a),e(t.element).off("CornerstoneToolsMouseUp",n)}function r(o,r){return t.isMouseButtonEnabled(r.which,o.data.mouseButtonMask)?(e(r.element).on("CornerstoneToolsMouseDrag",a),e(r.element).on("CornerstoneToolsMouseUp",n),!1):void 0}function a(e,t){return t.viewport.translation.x+=t.deltaPoints.page.x/t.viewport.scale,t.viewport.translation.y+=t.deltaPoints.page.y/t.viewport.scale,o.setViewport(t.element,t.viewport),!1}function i(e,t){var n=t;return n.viewport.translation.x+=n.deltaPoints.page.x/n.viewport.scale,n.viewport.translation.y+=n.deltaPoints.page.y/n.viewport.scale,o.setViewport(n.element,n.viewport),!1}return void 0===t&&(t={}),t.pan=t.simpleMouseButtonTool(r),t.panTouchDrag=t.touchDragTool(i),t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e,t){return console.log("MultiTouchPan"),t.viewport.translation.x+=t.deltaPoints.page.x/t.viewport.scale,t.viewport.translation.y+=t.deltaPoints.page.y/t.viewport.scale,o.setViewport(t.element,t.viewport),!1}function r(o){e(o).off("CornerstoneToolsMultiTouchDrag",n)}function a(o){e(o).off("CornerstoneToolsMultiTouchDrag",n),e(o).on("CornerstoneToolsMultiTouchDrag",n)}return void 0===t&&(t={}),t.panMultiTouch={activate:a,disable:r},t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e){var o={visible:!0,active:!0,handles:{end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0}}};return o}function r(e,o){return cornerstoneMath.point.distance(e.handles.end,o)<5}function a(e,n){var r=t.getToolState(e.currentTarget,i);if(void 0!==r){var a=n.canvasContext.canvas.getContext("2d");a.setTransform(1,0,0,1,0,0);for(var s,l=t.textStyle.getFont(),d=t.textStyle.getFontSize(),c=0;c<r.data.length;c++){a.save();var u=r.data[c];s=u.active?t.toolColors.getActiveColor():t.toolColors.getToolColor(),t.drawHandles(a,n,u.handles,s);var g=Math.round(u.handles.end.x),f=Math.round(u.handles.end.y),v=o.getStoredPixels(n.element,g,f,1,1),m=v[0],h=m*n.image.slope+n.image.intercept,T=t.calculateSUV(n.image,m),p={x:u.handles.end.x+3,y:u.handles.end.y-3},C=o.pixelToCanvas(n.element,p);a.font=l,a.fillStyle=s;var M=""+g+", "+f,x="SP: "+m+" MO: "+parseFloat(h.toFixed(3));T&&(x+=" SUV: "+parseFloat(T.toFixed(3))),t.drawTextBox(a,x,C.x,C.y+d+5,s),t.drawTextBox(a,M,C.x,C.y,s),a.restore()}}}void 0===t&&(t={});var i="probe";return t.probe=t.mouseButtonTool({createNewMeasurement:n,onImageRendered:a,pointNearTool:r,toolType:i}),t.probeTouch=t.touchTool({createNewMeasurement:n,onImageRendered:a,pointNearTool:r,toolType:i}),t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t,n){"use strict";function r(e){var o={visible:!0,active:!0,handles:{start:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!1},end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0}}};return o}function a(e,o){var n={left:Math.min(e.handles.start.x,e.handles.end.x),top:Math.min(e.handles.start.y,e.handles.end.y),width:Math.abs(e.handles.start.x-e.handles.end.x),height:Math.abs(e.handles.start.y-e.handles.end.y)},r=t.rect.distanceToPoint(n,o);return 5>r}function i(e,o){for(var t=0,n=0,r=0,a=0,i=o.top;i<o.top+o.height;i++)for(var s=o.left;s<o.left+o.width;s++)t+=e[a],n+=e[a]*e[a],r++,a++;if(0===r)return{count:r,mean:0,variance:0,stdDev:0};var l=t/r,d=n/r-l*l;return{count:r,mean:l,variance:d,stdDev:Math.sqrt(d)}}function s(e,t){var r=n.getToolState(e.currentTarget,l);if(void 0!==r){var a=t.canvasContext.canvas.getContext("2d");a.setTransform(1,0,0,1,0,0);for(var s,d=n.toolStyle.getToolWidth(),c=n.textStyle.getFont(),u=n.textStyle.getFontSize(),g=0;g<r.data.length;g++){a.save();var f=r.data[g];s=f.active?n.toolColors.getActiveColor():n.toolColors.getToolColor();var v=o.pixelToCanvas(t.element,f.handles.start),m=o.pixelToCanvas(t.element,f.handles.end),h=Math.abs(v.x-m.x),T=Math.abs(v.y-m.y),p=Math.min(v.x,m.x),C=Math.min(v.y,m.y),M=(v.x+m.x)/2,x=(v.y+m.y)/2;a.beginPath(),a.strokeStyle=s,a.lineWidth=d,a.rect(p,C,h,T),a.stroke(),n.drawHandles(a,t,f.handles,s);var y=Math.abs(f.handles.start.x-f.handles.end.x),w=Math.abs(f.handles.start.y-f.handles.end.y),I=Math.min(f.handles.start.x,f.handles.end.x),S=Math.min(f.handles.start.y,f.handles.end.y),P=o.getPixels(t.element,I,S,y,w),D={left:I,top:S,width:y,height:w},b=i(P,D),k=y*t.image.columnPixelSpacing*w*t.image.rowPixelSpacing,E="Area: "+k.toFixed(2)+" mm^2";a.font=c;var R=a.measureText(k),A=M<t.image.columns/2?M+h/2:M-h/2-R.width,B=x<t.image.rows/2?x+T/2:x-T/2;a.fillStyle=s,n.drawTextBox(a,"Mean: "+b.mean.toFixed(2),A,B-u-5,s),n.drawTextBox(a,"StdDev: "+b.stdDev.toFixed(2),A,B,s),n.drawTextBox(a,E,A,B+u+5,s),a.restore()}}}void 0===n&&(n={});var l="rectangleRoi";return n.rectangleRoi=n.mouseButtonTool({createNewMeasurement:r,onImageRendered:s,pointNearTool:a,toolType:l}),n.rectangleRoiTouch=n.touchTool({createNewMeasurement:r,onImageRendered:s,pointNearTool:a,toolType:l}),n}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e){var o=e.element.getBoundingClientRect(e.element),t={x:e.currentPoints.client.x,y:e.currentPoints.client.y},n=e.element.clientWidth,r=e.element.clientHeight,a={x:t.x-o.left-n/2,y:-1*(t.y-o.top-r/2)},i=Math.atan2(a.y,a.x),s=i*(180/Math.PI),l=-1*s+90;e.viewport.rotation=l}function r(e){e.viewport.rotation+=e.deltaPoints.page.x/e.viewport.scale}function a(e){e.viewport.rotation+=e.deltaPoints.page.y/e.viewport.scale}function i(o,t){e(t.element).off("CornerstoneToolsMouseDrag",l),e(t.element).off("CornerstoneToolsMouseUp",i)}function s(o,n){return t.isMouseButtonEnabled(n.which,o.data.mouseButtonMask)?(e(n.element).on("CornerstoneToolsMouseDrag",l),e(n.element).on("CornerstoneToolsMouseUp",i),!1):void 0}function l(e,n){return t.rotate.strategy(n),o.setViewport(n.element,n.viewport),e.stopPropagation(),!1}function d(e,n){return t.rotate.strategy(n),o.setViewport(n.element,n.viewport),!1}return void 0===t&&(t={}),t.rotate=t.simpleMouseButtonTool(s),t.rotate.strategies={"default":n,horizontal:r,vertical:a},t.rotate.strategy=n,t.rotateTouchDrag=t.touchDragTool(d),t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e,t){return t.viewport.rotation+=t.rotation,o.setViewport(t.element,t.viewport),!1}function r(o){e(o).off("CornerstoneToolsTouchRotate",n)}function a(o){e(o).off("CornerstoneToolsTouchRotate",n),e(o).on("CornerstoneToolsTouchRotate",n)}return void 0===t&&(t={}),t.rotateTouch={activate:a,disable:r},t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(o,t){var n,r=e(o).find("canvas").get(0),a=document.createElement("a");a.download=t,a.href=r.toDataURL(),document.createEvent?(n=document.createEvent("MouseEvents"),n.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),a.dispatchEvent(n)):a.fireEvent&&a.fireEvent("onclick")}return void 0===t&&(t={}),t.saveAs=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t,n){"use strict";function r(e){var o={visible:!0,active:!0,handles:{start:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!1},middle:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0},end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!1}}};return o}function a(e,o){var n={start:e.handles.start,end:e.handles.middle},r=t.lineSegment.distanceToPoint(n,o);return 5>r?!0:(n.start=e.handles.middle,n.end=e.handles.end,r=t.lineSegment.distanceToPoint(n,o),5>r)}function i(e){return Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2))}function s(e,t){var r=n.getToolState(e.currentTarget,C);if(void 0!==r){var a=t.canvasContext.canvas.getContext("2d");a.setTransform(1,0,0,1,0,0);for(var s,l=n.toolStyle.getToolWidth(),d=n.textStyle.getFont(),c=0;c<r.data.length;c++){a.save();var u=r.data[c];s=u.active?n.toolColors.getActiveColor():n.toolColors.getToolColor(),a.beginPath(),a.strokeStyle=s,a.lineWidth=l;var g=o.pixelToCanvas(t.element,u.handles.start),f=o.pixelToCanvas(t.element,u.handles.middle);a.moveTo(g.x,g.y),a.lineTo(f.x,f.y);var v=o.pixelToCanvas(t.element,u.handles.end);a.lineTo(v.x,v.y),a.stroke(),n.drawHandles(a,t,u.handles),a.fillStyle=s;var m={x:(Math.ceil(u.handles.middle.x)-Math.ceil(u.handles.start.x))*t.image.columnPixelSpacing,y:(Math.ceil(u.handles.middle.y)-Math.ceil(u.handles.start.y))*t.image.rowPixelSpacing},h={x:(Math.ceil(u.handles.end.x)-Math.ceil(u.handles.middle.x))*t.image.columnPixelSpacing,y:(Math.ceil(u.handles.end.y)-Math.ceil(u.handles.middle.y))*t.image.rowPixelSpacing},T={x:(Math.ceil(u.handles.end.x)-Math.ceil(u.handles.start.x))*t.image.columnPixelSpacing,y:(Math.ceil(u.handles.end.y)-Math.ceil(u.handles.start.y))*t.image.rowPixelSpacing},p=i(m),M=i(h),x=i(T),y=Math.acos((Math.pow(p,2)+Math.pow(M,2)-Math.pow(x,2))/(2*p*M));y*=180/Math.PI;var w=n.roundToDecimal(y,2);if(w){var I="00B0",S=w.toString()+String.fromCharCode(parseInt(I,16)),P=15,D=f.x+P,b=f.y+P,k=a.measureText(u.annotationText).width;D=f.x-g.x<0?f.x-P-k-10:f.x+P,b=f.y,a.font=d,n.drawTextBox(a,S,D,b,s)}a.restore()}}}function l(t){function a(e,t){var n=s.handles.end;n.x=t.currentPoints.image.x,n.y=t.currentPoints.image.y,n.x<0&&(n.x=0),n.x>t.image.width&&(n.x=t.image.width),n.y<0&&(n.y=0),n.y>t.image.height&&(n.y=t.image.height),o.updateImage(t.element)}function i(o){var t=s.handles.end;t.active=!1,e(o.element).off("CornerstoneToolsMouseMove",a),e(o.element).off("CornerstoneToolsMouseUp",i),e(o.element).on("CornerstoneToolsMouseMove",c)}var s=r(t);n.addToolState(t.element,C,s),e(t.element).off("CornerstoneToolsMouseMove",c),n.moveHandle(t,s.handles.middle,function(){s.active=!1,n.anyHandlesOutsideImage(t,s.handles)&&n.removeToolState(t.element,C,s),s.handles.end.active=!0,e(t.element).on("CornerstoneToolsMouseMove",a),e(t.element).on("CornerstoneToolsMouseUp",i)})}function d(e,o){return n.isMouseButtonEnabled(o.which,e.data.mouseButtonMask)?(l(o),!1):void 0}function c(e,t){if(n.toolCoordinates.setCoords(t),0===t.which){var r=n.getToolState(t.element,C);if(void 0!==r){for(var i=!1,s=0;s<r.data.length;s++){var l=r.data[s];n.handleActivator(l.handles,t.currentPoints.image,t.viewport.scale)===!0&&(i=!0),(a(l,t.currentPoints.image)&&!l.active||!a(l,t.currentPoints.image)&&l.active)&&(l.active=!l.active,i=!0)}i===!0&&o.updateImage(t.element)}}}function u(e,o){for(var n in e.handles){var r=t.point.distanceSquared(e.handles[n],o);if(25>r)return e.handles[n]}}function g(t,r){function i(){s.active=!1,n.anyHandlesOutsideImage(r,s.handles)&&n.removeToolState(r.element,C,s),o.updateImage(r.element),e(r.element).on("CornerstoneToolsMouseMove",c)}var s;if(n.isMouseButtonEnabled(r.which,t.data.mouseButtonMask)){var l,d=r.startPoints.image,g=n.getToolState(t.currentTarget,C);if(void 0!==g)for(l=0;l<g.data.length;l++){s=g.data[l];var f=u(s,d);if(void 0!==f)return e(r.element).off("CornerstoneToolsMouseMove",c),s.active=!0,n.moveHandle(r,f,i),t.stopImmediatePropagation(),!1}if(void 0!==g&&void 0!==a)for(l=0;l<g.data.length;l++)if(s=g.data[l],a(s,d))return e(r.element).off("CornerstoneToolsMouseMove",c),n.moveAllHandles(t,s,g,!0),e(r.element).on("CornerstoneToolsMouseMove",c),t.stopImmediatePropagation(),!1}}function f(t){e(t).off("CornerstoneImageRendered",s),e(t).off("CornerstoneToolsMouseMove",c),e(t).off("CornerstoneToolsMouseDown",g),e(t).off("CornerstoneToolsMouseDownActivate",d),o.updateImage(t)}function v(t){e(t).off("CornerstoneImageRendered",s),e(t).off("CornerstoneToolsMouseMove",c),e(t).off("CornerstoneToolsMouseDown",g),e(t).off("CornerstoneToolsMouseDownActivate",d),e(t).on("CornerstoneImageRendered",s),o.updateImage(t)}function m(t,n){var r={mouseButtonMask:n};e(t).off("CornerstoneImageRendered",s),e(t).off("CornerstoneToolsMouseMove",c),e(t).off("CornerstoneToolsMouseDown",g),e(t).off("CornerstoneToolsMouseDownActivate",d),e(t).on("CornerstoneImageRendered",s),e(t).on("CornerstoneToolsMouseMove",r,c),e(t).on("CornerstoneToolsMouseDown",r,g),e(t).on("CornerstoneToolsMouseDownActivate",r,d),o.updateImage(t)}function h(t,n){var r={mouseButtonMask:n};e(t).off("CornerstoneImageRendered",s),e(t).off("CornerstoneToolsMouseMove",c),e(t).off("CornerstoneToolsMouseDown",g),e(t).off("CornerstoneToolsMouseDownActivate",d),e(t).on("CornerstoneImageRendered",s),e(t).on("CornerstoneToolsMouseMove",r,c),e(t).on("CornerstoneToolsMouseDown",r,g),o.updateImage(t)}function T(){return M}function p(e){M=e}void 0===n&&(n={});var C="simpleAngle",M={};return n.simpleAngle={enable:v,disable:f,activate:m,deactivate:h,getConfiguration:T,setConfiguration:p,pointNearTool:a},n}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e){var o=t.textMarker.getConfiguration();if(o.current){var n={visible:!0,active:!0,text:o.current,handles:{end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0}}},r=o.markers.indexOf(o.current);return o.ascending?(r+=1,r>=o.markers.length&&(o.loop?r-=o.markers.length:r=-1)):(r-=1,0>r&&(o.loop?r+=o.markers.length:r=-1)),o.current=o.markers[r],n}}function r(e,o){var t={left:e.handles.end.x-e.textWidth/2,top:e.handles.end.y,width:e.textWidth,height:e.textHeight},n=cornerstoneMath.rect.distanceToPoint(t,o);return 10>n}function a(e,n){var r=t.getToolState(e.currentTarget,p);if(void 0!==r){var a=n.canvasContext.canvas.getContext("2d");a.setTransform(1,0,0,1,0,0);for(var i,s=t.textStyle.getFont(),l=t.textStyle.getFontSize(),d=o.getViewport(n.element),c=0;c<r.data.length;c++){var u=r.data[c];i=u.active?t.toolColors.getActiveColor():t.toolColors.getToolColor(),a.save(),a.font=s,a.fillStyle=i;var g=a.measureText(u.text);u.textWidth=g.width/d.scale,u.textHeight=l/d.scale;var f={x:u.handles.end.x-u.textWidth/2,y:u.handles.end.y},v=o.pixelToCanvas(n.element,f);t.drawTextBox(a,u.text,v.x,v.y,i),a.restore()}}}function i(o){var r=n(o);r&&(t.addToolState(o.element,p,r),e(o.element).off("CornerstoneToolsMouseMove",d),t.moveHandle(o,r.handles.end,function(){r.active=!1,t.anyHandlesOutsideImage(o,r.handles)&&t.removeToolState(o.element,p,r),e(o.element).on("CornerstoneToolsMouseMove",d)}))}function s(e,n){function a(e,t){e.text=t,o.updateImage(n.element)}var i;if(t.isMouseButtonEnabled(n.which,e.data.mouseButtonMask)){var s,l=t.textMarker.getConfiguration(),d=(n.startPoints.image,t.getToolState(e.currentTarget,p));if(void 0!==d)for(s=0;s<d.data.length;s++)if(i=d.data[s],r(i,n.currentPoints.image))return l.changeTextCallback(i,a),e.stopImmediatePropagation(),!1;return!1}}function l(e,o){return t.isMouseButtonEnabled(o.which,e.data.mouseButtonMask)?(i(o),!1):void 0}function d(e,n){if(t.toolCoordinates.setCoords(n),0===n.which){var a=t.getToolState(n.element,p);if(void 0!==a){for(var i=!1,s=0;s<a.data.length;s++){var l=a.data[s];t.handleActivator(l.handles,n.currentPoints.image,n.viewport.scale)===!0&&(i=!0),(r(l,n.currentPoints.image)&&!l.active||!r(l,n.currentPoints.image)&&l.active)&&(l.active=!l.active,i=!0)}i===!0&&o.updateImage(n.element)}}}function c(e,o){for(var t in e.handles){var n=cornerstoneMath.point.distanceSquared(e.handles[t],o);if(25>n)return e.handles[t]}}function u(n,a){function i(){s.active=!1,t.anyHandlesOutsideImage(a,s.handles)&&t.removeToolState(a.element,p,s),o.updateImage(a.element),e(a.element).on("CornerstoneToolsMouseMove",d)}var s;if(t.isMouseButtonEnabled(a.which,n.data.mouseButtonMask)){var l,u=a.startPoints.image,g=t.getToolState(n.currentTarget,p);if(void 0!==g)for(l=0;l<g.data.length;l++){s=g.data[l];var f=c(s,u);if(void 0!==f)return s.active=!0,a.event.shiftKey?(t.removeToolState(a.element,p,s),o.updateImage(a.element),n.stopImmediatePropagation(),!1):(e(a.element).off("CornerstoneToolsMouseMove",d),t.moveHandle(a,f,i),n.stopImmediatePropagation(),!1)}if(void 0!==g&&void 0!==r)for(l=0;l<g.data.length;l++)if(s=g.data[l],r(s,u))return e(a.element).off("CornerstoneToolsMouseMove",d),t.moveAllHandles(n,s,g,!0),e(a.element).on("CornerstoneToolsMouseMove",d),n.stopImmediatePropagation(),!1}}function g(t){e(t).off("CornerstoneImageRendered",a),e(t).off("CornerstoneToolsMouseMove",d),e(t).off("CornerstoneToolsMouseDown",u),e(t).off("CornerstoneToolsMouseDownActivate",l),e(t).off("CornerstoneToolsMouseDoubleClick",s),o.updateImage(t)}function f(t){e(t).off("CornerstoneImageRendered",a),e(t).off("CornerstoneToolsMouseMove",d),e(t).off("CornerstoneToolsMouseDown",u),e(t).off("CornerstoneToolsMouseDownActivate",l),e(t).off("CornerstoneToolsMouseDoubleClick",s),e(t).on("CornerstoneImageRendered",a),o.updateImage(t)}function v(t,n){var r={mouseButtonMask:n};e(t).off("CornerstoneImageRendered",a),e(t).off("CornerstoneToolsMouseMove",d),e(t).off("CornerstoneToolsMouseDown",u),e(t).off("CornerstoneToolsMouseDownActivate",l),e(t).off("CornerstoneToolsMouseDoubleClick",s),e(t).on("CornerstoneImageRendered",a),e(t).on("CornerstoneToolsMouseMove",r,d),e(t).on("CornerstoneToolsMouseDown",r,u),e(t).on("CornerstoneToolsMouseDownActivate",r,l),e(t).on("CornerstoneToolsMouseDoubleClick",r,s),o.updateImage(t)}function m(t,n){var r={mouseButtonMask:n};e(t).off("CornerstoneImageRendered",a),e(t).off("CornerstoneToolsMouseMove",d),e(t).off("CornerstoneToolsMouseDown",u),e(t).off("CornerstoneToolsMouseDownActivate",l),e(t).off("CornerstoneToolsMouseDoubleClick",s),e(t).on("CornerstoneImageRendered",a),e(t).on("CornerstoneToolsMouseMove",r,d),e(t).on("CornerstoneToolsMouseDown",r,u),e(t).on("CornerstoneToolsMouseDoubleClick",r,s),o.updateImage(t)}function h(){return C}function T(e){C=e}void 0===t&&(t={});var p="textMarker",C={};return t.textMarker={enable:f,disable:g,activate:v,deactivate:m,getConfiguration:h,setConfiguration:T,pointNearTool:r},t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(o,t){e(t.element).off("CornerstoneToolsMouseDrag",i),
e(t.element).off("CornerstoneToolsMouseUp",n)}function r(o,r){return t.isMouseButtonEnabled(r.which,o.data.mouseButtonMask)?(e(r.element).on("CornerstoneToolsMouseDrag",i),e(r.element).on("CornerstoneToolsMouseUp",n),!1):void 0}function a(e){var o=e.image.maxPixelValue-e.image.minPixelValue,t=o/1024,n=e.deltaPoints.page.x*t,r=e.deltaPoints.page.y*t;e.viewport.voi.windowWidth+=n,e.viewport.voi.windowCenter+=r}function i(e,n){return t.wwwc.strategy(n),o.setViewport(n.element,n.viewport),!1}function s(e,n){var r=n,a=r.image.maxPixelValue-r.image.minPixelValue,i=a/1024,s=r.deltaPoints.page.x*i,l=r.deltaPoints.page.y*i,d=t.wwwc.getConfiguration();d.orientation?0===d.orientation?(r.viewport.voi.windowWidth+=s,r.viewport.voi.windowCenter+=l):(r.viewport.voi.windowWidth+=l,r.viewport.voi.windowCenter+=s):(r.viewport.voi.windowWidth+=s,r.viewport.voi.windowCenter+=l),o.setViewport(r.element,r.viewport)}return void 0===t&&(t={}),t.wwwc=t.simpleMouseButtonTool(r),t.wwwc.strategies={"default":a},t.wwwc.strategy=a,t.wwwcTouchDrag=t.touchDragTool(s),t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t,n){"use strict";function r(e,o,t){var n=e.length;if(2>n)return{min:o,max:t};for(var r=t,a=o,i=e,s=0;n>s;s++){var l=i[s];r=Math.min(r,l),a=Math.max(a,l)}return{min:r,max:a}}function a(o,t){e(t.element).off("CornerstoneToolsMouseDrag",d),e(t.element).off("CornerstoneToolsMouseUp",a);var r=n.getToolState(t.element,m);if(void 0!==r&&r.data.length){var l={x:t.currentPoints.image.x,y:t.currentPoints.image.y};r.data[0].endPoint=l,i(t),e(t.element).on("CornerstoneToolsMouseDown",t,s)}}function i(e){var t=n.getToolState(e.element,m);if(void 0!==t&&t.data.length){var a=t.data[0].startPoint,i=t.data[0].endPoint,s=Math.abs(a.x-i.x),l=Math.abs(a.y-i.y),d=Math.min(a.x,i.x),c=Math.min(a.y,i.y),u=o.getPixels(e.element,d,c,s,l),g=r(u,e.image.minPixelValue,e.image.maxPixelValue),f=o.getViewport(e.element);f.voi.windowWidth=Math.abs(g.max-g.min),f.voi.windowCenter=(g.max-g.min)/2,o.setViewport(e.element,f),t.data=[],o.updateImage(e.element)}}function s(o,t){return n.isMouseButtonEnabled(t.which,o.data.mouseButtonMask)?(e(t.element).on("CornerstoneToolsMouseDrag",d),e(t.element).on("CornerstoneToolsMouseUp",a),l(t),!1):void 0}function l(e){var o=n.getToolState(e.element,m);o&&o.data&&(o.data=[]);var t={startPoint:{x:e.currentPoints.image.x,y:e.currentPoints.image.y}};n.addToolState(e.element,m,t)}function d(e,t){var r=n.getToolState(t.element,m);if(void 0!==r&&r.data.length){var a={x:t.currentPoints.image.x,y:t.currentPoints.image.y};r.data[0].endPoint=a,o.updateImage(t.element)}}function c(t,r){var a=n.getToolState(r.element,m);if(void 0!==a&&a.data.length){var i=a.data[0].startPoint,s=a.data[0].endPoint;if(i){var l=e(r.element).find("canvas").get(0),d=l.getContext("2d");d.setTransform(1,0,0,1,0,0);var c=n.toolColors.getActiveColor(),u=o.pixelToCanvas(r.element,i),g=o.pixelToCanvas(r.element,s),f=Math.min(u.x,g.x),v=Math.min(u.y,g.y),h=Math.abs(u.x-g.x),T=Math.abs(u.y-g.y),p=n.toolStyle.getToolWidth();d.save(),d.beginPath(),d.strokeStyle=c,d.lineWidth=p,d.rect(f,v,h,T),d.stroke(),d.restore()}}}function u(t){e(t).off("CornerstoneToolsMouseDown",s),e(t).off("CornerstoneImageRendered",c),o.updateImage(t)}function g(t,r){var i={mouseButtonMask:r},l=n.getToolState(t,m);if(void 0===l){var u=[];n.addToolState(t,m,u)}e(t).off("CornerstoneToolsMouseDown",s),e(t).off("CornerstoneToolsMouseUp",a),e(t).off("CornerstoneToolsMouseDrag",d),e(t).off("CornerstoneImageRendered",c),e(t).on("CornerstoneToolsMouseDown",i,s),e(t).on("CornerstoneToolsMouseUp",a),e(t).on("CornerstoneToolsMouseDrag",d),e(t).on("CornerstoneImageRendered",c),o.updateImage(t)}function f(o){e(o).off("CornerstoneToolsTouchDrag",d),e(o).off("CornerstoneToolsDragStart",l),e(o).off("CornerstoneToolsDragEnd",i),e(o).off("CornerstoneImageRendered",c)}function v(o){var t=n.getToolState(o,m);if(void 0===t){var r=[];n.addToolState(o,m,r)}e(o).off("CornerstoneToolsTouchDrag",d),e(o).off("CornerstoneToolsDragStart",l),e(o).off("CornerstoneToolsDragEnd",i),e(o).off("CornerstoneImageRendered",c),e(o).on("CornerstoneToolsTouchDrag",d),e(o).on("CornerstoneToolsDragStart",l),e(o).on("CornerstoneToolsDragEnd",i),e(o).on("CornerstoneImageRendered",c)}void 0===n&&(n={});var m="wwwcRegion";return n.wwwcRegion={activate:g,deactivate:u,disable:u},n.wwwcRegionTouch={activate:v,deactivate:f,disable:f},n}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e,o){if(0!==o.rotation){var t=o.rotation*Math.PI/180,n=Math.cos(t),r=Math.sin(t),a=e.x*n-e.y*r,i=e.x*r+e.y*n;e.x=a,e.y=i}return o.hflip&&(e.x*=-1),o.vflip&&(e.y*=-1),e}function r(e,t,n){var r=1.7,a=Math.log(t.scale)/Math.log(r),i=a+n,s=Math.pow(r,i);t.scale=s,o.setViewport(e,t)}function a(o,t){e(t.element).off("CornerstoneToolsMouseDrag",s),e(t.element).off("CornerstoneToolsMouseUp",a)}function i(o,n){return t.isMouseButtonEnabled(n.which,o.data.mouseButtonMask)?(e(n.element).on("CornerstoneToolsMouseDrag",s),e(n.element).on("CornerstoneToolsMouseUp",a),!1):void 0}function s(e,t){var a=t.deltaPoints.page.y/100;r(t.element,t.viewport,a);var i=o.pageToPixel(t.element,t.startPoints.page.x,t.startPoints.page.y),s={x:t.startPoints.image.x-i.x,y:t.startPoints.image.y-i.y};return s=n(s,t.viewport),t.viewport.translation.x-=s.x,t.viewport.translation.y-=s.y,o.setViewport(t.element,t.viewport),!1}function l(e,o){var t=-o.direction/4;r(o.element,o.viewport,t)}function d(e,o){var t=o;r(t.element,t.viewport,t.direction/4)}function c(e,t){var a=t,i=a.deltaPoints.page.y/100;r(a.element,a.viewport,i);var s=o.pageToPixel(a.element,a.startPoints.page.x,a.startPoints.page.y),l={x:a.startPoints.image.x-s.x,y:a.startPoints.image.y-s.y};return l=n(l,a.viewport),a.viewport.translation.x-=l.x,a.viewport.translation.y-=l.y,o.setViewport(a.element,a.viewport),!1}return void 0===t&&(t={}),t.zoom=t.simpleMouseButtonTool(i),t.zoomWheel=t.mouseWheelTool(l),t.zoomTouchPinch=t.touchPinchTool(d),t.zoomTouchDrag=t.touchDragTool(c),t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(t){var n=t.currentTarget,r=o.pageToPixel(n,s,l);t=window.event||t;var a={element:n,viewport:o.getViewport(n),image:o.getEnabledElement(n).image,pageX:s,pageY:l,imageX:r.x,imageY:r.y,keyCode:t.keyCode,which:t.which};"keydown"===t.type?e(n).trigger("CornerstoneToolsKeyDown",a):"keypress"===t.type?e(n).trigger("CornerstoneToolsKeyPress",a):"keyup"===t.type&&e(n).trigger("CornerstoneToolsKeyUp",a)}function r(e){s=e.pageX||e.originalEvent.pageX,l=e.pageY||e.originalEvent.pageY}function a(o){e(o).bind(d,n),e(o).on("mousemove",r)}function i(o){e(o).unbind(d,n)}void 0===t&&(t={});var s,l,d="keydown keypress keyup";return t.keyboardInput={enable:a,disable:i},t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t,n){"use strict";function r(e,o){var n=e.image,r={left:0,top:0,width:n.width,height:n.height},a=!1;for(var i in o){var s=o[i];t.point.insideRect(s,r)===!1&&(a=!0)}return a}return void 0===n&&(n={}),n.anyHandlesOutsideImage=r,n}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e,n,a,i,s){e.strokeStyle=i;for(var l in a){var d=a[l];if(d.active||d.highlight){e.beginPath(),d.active?e.lineWidth=t.toolStyle.getActiveWidth():e.lineWidth=t.toolStyle.getToolWidth();var c=o.pixelToCanvas(n.element,d);e.arc(c.x,c.y,r,0,2*Math.PI),s&&(e.fillStyle=s,e.fill()),e.stroke()}}}void 0===t&&(t={});var r=6;return t.drawHandles=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t,n){"use strict";function r(e,o,n){var r=s/n;for(var a in e){var i=e[a],l=t.point.distance(o,i);if(r>=l)return i}return void 0}function a(e){for(var o in e){var t=e[o];if(t.active===!0)return t}return void 0}function i(e,o,t){var n=a(e),i=r(e,o,t);return n!==i?(void 0!==i&&(i.active=!0),void 0!==n&&(n.active=!1),!0):!1}void 0===n&&(n={});var s=6;return n.handleActivator=i,n}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(t,n,r,a){function i(e,t){n.active=!0,n.x=t.currentPoints.image.x,n.y=t.currentPoints.image.y,a&&(n.x<0&&(n.x=0),n.x>t.image.width&&(n.x=t.image.width),n.y<0&&(n.y=0),n.y>t.image.height&&(n.y=t.image.height)),o.updateImage(l)}function s(t,a){n.active=!1,e(l).off("CornerstoneToolsMouseDrag",i),e(l).off("CornerstoneToolsMouseUp",s),o.updateImage(l),r()}var l=t.element;e(l).on("CornerstoneToolsMouseDrag",i),e(l).on("CornerstoneToolsMouseUp",s)}return void 0===t&&(t={}),t.moveHandle=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(t,n,r){function a(e,t){n.active=!0;var r=t;n.x=r.currentPoints.image.x,n.y=r.currentPoints.image.y,o.updateImage(s)}function i(t){n.active=!1,e(s).off("CornerstoneToolsTouchDrag",a),e(s).off("CornerstoneToolsDragEnd",i),o.updateImage(s),r()}var s=t.element;e(s).on("CornerstoneToolsTouchDrag",a),e(s).on("CornerstoneToolsDragEnd",i)}return void 0===t&&(t={}),t.touchMoveHandle=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t,n){"use strict";function r(n,r,a,i,s){function l(e,t){r.active=!0;for(var n in r.handles){var a=r.handles[n];a.x+=t.deltaPoints.image.x,a.y+=t.deltaPoints.image.y,s&&(a.x<0&&(a.x=0),a.x>t.image.width&&(a.x=t.image.width),a.y<0&&(a.y=0),a.y>t.image.height&&(a.y=t.image.height))}return o.updateImage(u),!1}function d(n,s){if(r.active=!1,e(u).off("CornerstoneToolsMouseDrag",l),e(u).off("CornerstoneToolsMouseUp",d),i===!0){var c=s.image,g=!1,f={top:0,left:0,width:c.width,height:c.height};for(var v in r.handles){var m=r.handles[v];m.active=!1,t.point.insideRect(m,f)===!1&&(g=!0)}if(g){for(var h=-1,T=0;T<a.data.length;T++)a.data[T]===r&&(h=T);-1!==h&&a.data.splice(h,1)}}o.updateImage(u)}var c=n,u=c.element;return e(u).on("CornerstoneToolsMouseDrag",l),e(u).on("CornerstoneToolsMouseUp",d),!0}return void 0===n&&(n={}),n.moveAllHandles=r,n}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(e,o,t,n){"use strict";function r(n,r,a,i){function s(e,t){r.active=!0;for(var n in r.handles){var a=r.handles[n];a.x+=t.deltaPoints.image.x,a.y+=t.deltaPoints.image.y}return o.updateImage(d),!1}function l(n,c){r.active=!1;if(e(d).off("CornerstoneToolsTouchDrag",s),e(d).off("CornerstoneToolsDragEnd",l),i===!0){var u=c.image,g=!1,f={top:0,left:0,width:u.width,height:u.height};for(var v in r.handles){var m=r.handles[v];t.point.insideRect(m,f)===!1&&(g=!0)}if(g){for(var h=-1,T=0;T<a.data.length;T++)a.data[T]===r&&(h=T);-1!==h&&a.data.splice(h,1)}}o.updateImage(d)}var d=n.element;return e(d).on("CornerstoneToolsTouchDrag",s),e(d).on("CornerstoneToolsDragEnd",l),!0}return void 0===n&&(n={}),n.touchMoveAllHandles=r,n}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(){var o=this;o.samples=[],this.set=function(t){o.samples=t,e(o).trigger("CornerstoneLineSampleUpdated")}}return void 0===t&&(t={}),t.LineSampleMeasurement=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(){var o=this;o.measurements=[],this.add=function(t){var n=o.measurements.push(t),r={index:n,measurement:t};e(o).trigger("CornerstoneMeasurementAdded",r)},this.remove=function(t){var n=o.measurements[t];o.measurements.splice(t,1);var r={index:t,measurement:n};e(o).trigger("CornerstoneMeasurementRemoved",r)}}return void 0===t&&(t={}),t.MeasurementManager=new n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e){i.push(e)}function r(e){var o=i.indexOf(e);-1!==o&&i.splice(o,1)}function a(o,t){var n;return e.each(i,function(e,r){return n=r(o,t),void 0!==n?!0:void 0}),n}void 0===t&&(t={});var i=[];return t.metaData={addProvider:n,removeProvider:r,get:a},t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e){for(var o="",t=e.y<0?"R":"L",n=e.y<0?"A":"P",r=e.z<0?"F":"H",a=new cornerstoneMath.Vector3(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z)),i=0;3>i;i++)if(a.x>1e-4&&a.x>a.y&&a.x>a.z)o+=t,a.x=0;else if(a.y>1e-4&&a.y>a.x&&a.y>a.z)o+=n,a.y=0;else{if(!(a.z>1e-4&&a.z>a.x&&a.z>a.y))break;o+=r,a.z=0}return o}return void 0===t&&(t={}),void 0===t.orientation&&(t.orientation={}),t.orientation.getOrientationString=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e){var o=e.replace("H","f");return o=o.replace("F","h"),o=o.replace("R","l"),o=o.replace("L","r"),o=o.replace("A","p"),o=o.replace("P","a"),o=o.toUpperCase()}return void 0===t&&(t={}),void 0===t.orientation&&(t.orientation={}),t.orientation.invertOrientationString=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e,o){var n=o.imagePositionPatient,r=t.projectPatientPointToImagePlane(n,e),a=t.imagePointToPatientPoint({x:o.columns,y:o.rows},o),i=t.projectPatientPointToImagePlane(a,e),s={start:{x:r.x,y:r.y},end:{x:i.x,y:i.y}};return s}return void 0===t&&(t={}),void 0===t.referenceLines&&(t.referenceLines={}),t.referenceLines.calculateReferenceLine=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(n,r){var a=t.getToolState(n.currentTarget,i);if(void 0!==a){var s=a.data[0].synchronizationContext,l=s.getSourceElements(),d=a.data[0].renderer,c=r.canvasContext.canvas.getContext("2d");o.setToPixelCoordinateSystem(r.enabledElement,c),e.each(l,function(e,o){o!==n.currentTarget&&d(c,r,n.currentTarget,o)})}}function r(r,a,s){s=s||t.referenceLines.renderActiveReferenceLine,t.addToolState(r,i,{synchronizationContext:a,renderer:s}),e(r).on("CornerstoneImageRendered",n),o.updateImage(r)}function a(t,r){e(t).off("CornerstoneImageRendered",n),o.updateImage(t)}void 0===t&&(t={}),void 0===t.referenceLines&&(t.referenceLines={});var i="referenceLines";return t.referenceLines.tool={enable:r,disable:a},t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e,n,r,a){var i=o.getEnabledElement(r).image,s=o.getEnabledElement(a).image;if(void 0!==i&&void 0!==s){var l=t.metaData.get("imagePlane",i.imageId),d=t.metaData.get("imagePlane",s.imageId);if(l.frameOfReferenceUID==d.frameOfReferenceUID){var c=l.rowCosines.clone().cross(l.columnCosines),u=d.rowCosines.clone().cross(d.columnCosines),g=c.angleTo(u);if(g=Math.abs(g),!(.5>g)){var f=t.referenceLines.calculateReferenceLine(l,d),v=o.pixelToCanvas(n.element,f.start),m=o.pixelToCanvas(n.element,f.end),h=t.toolColors.getActiveColor(),T=t.toolStyle.getToolWidth();e.setTransform(1,0,0,1,0,0),e.save(),e.beginPath(),e.strokeStyle=h,e.lineWidth=T,e.moveTo(v.x,v.y),e.lineTo(m.x,m.y),e.stroke(),e.restore()}}}}return void 0===t&&(t={}),void 0===t.referenceLines&&(t.referenceLines={}),t.referenceLines.renderActiveReferenceLine=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(n,r){if(void 0===n)throw"playClip: element must not be undefined";void 0===r&&(r=30);var i=t.getToolState(n,"stack");if(void 0!==i&&void 0!==i.data&&0!==i.data.length){var s,l=i.data[0],d=t.getToolState(n,a);void 0===d||0===d.data.length?(s={intervalId:void 0,framesPerSecond:r,lastFrameTimeStamp:void 0,frameRate:0,loop:!0},t.addToolState(n,a,s)):(s=d.data[0],s.framesPerSecond=r),void 0===s.intervalId&&(s.intervalId=setInterval(function(){var r=l.currentImageIdIndex;if(s.framesPerSecond>0?r++:r--,!s.loop&&(r>=l.imageIds.length||0>r)){var a={element:n},i=jQuery.Event("CornerstoneToolsClipStopped",a);return e(n).trigger(i,a),clearInterval(s.intervalId),void(s.intervalId=void 0)}if(r>=l.imageIds.length&&(r=0),0>r&&(r=l.imageIds.length-1),r!==l.currentImageIdIndex){var d=t.loadHandlerManager.getStartLoadHandler(),c=t.loadHandlerManager.getEndLoadHandler();d&&d(n);var u=o.getViewport(n);o.loadAndCacheImage(l.imageIds[r]).then(function(e){l.currentImageIdIndex=r,o.displayImage(n,e,u),c&&c(n)})}},1e3/Math.abs(s.framesPerSecond)))}}function r(e){var o,n=t.getToolState(e,a);void 0!==n&&0!==n.data.length&&(o=n.data[0],clearInterval(o.intervalId),o.intervalId=void 0)}void 0===t&&(t={});var a="playClip";return t.playClip=n,t.stopClip=r,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e,o){clearTimeout(c),c=setTimeout(function(){var e=o.element,n=t.getToolState(e,"stack");if(n&&n.data&&n.data.length){var r=t.getToolState(e,u);if(r&&r.data&&r.data.length){var i=r.data[0];i.indicesToRequest.length>0&&!i.enabled&&(i.enabled=!0,a(e))}}},50)}function r(e,o){for(var t=[],n=o-e+1;n--;)t[n]=o--;return t}function a(n){function i(e){var o=v.indicesToRequest.indexOf(e);o>-1&&v.indicesToRequest.splice(o,1)}function s(e){throw"stackPrefetch: image not retrieved: "+e}function l(e){i(e);var t=o.imageCache.getCacheInfo();x&&t.cacheSizeInBytes===x.cacheSizeInBytes&&(v.enabled=!1),x=t}var d=t.getToolState(n,"stack");if(void 0!==d&&void 0!==d.data&&0!==d.data.length){var c=d.data[0],g=c.currentImageIdIndex,f=t.getToolState(n,u);if(void 0!==f){var v=f.data[0];if(0===v.indicesToRequest.length&&(v.enabled=!1),v.enabled!==!1){var m=v.indicesToRequest.slice();m.forEach(function(e){var t=c.imageIds[e];if(t){var n=o.imageCache.getImagePromise(t);void 0!==n&&"resolved"===n.state()&&i(e)}});var h=t.stackPrefetch.getConfiguration(),T=c.imageIds.length,p=v.lastImageIdIndexFetched;p||(p=g);var C=p+h.maxSimultaneousRequests;C>=T&&(C=T-1);var M=r(p,C);v.lastImageIdIndexFetched=C+1;var x,y=[];if(0===M.length)return void(v.enabled=!1);M.forEach(function(e){var t=c.imageIds[e];if(v.enabled&&t){var n=o.imageCache.getImagePromise(t);if(void 0!==n)return void n.done(function(){l(e)});var r=o.loadAndCacheImage(t);r.done(function(){l(e)}),r.fail(function(){s(t)}),y.push(r)}}),e.when.apply(e,y).done(function(){v.indicesToRequest.length>0&&v.enabled&&setTimeout(a(n),1)}),e.when.apply(e,y).fail(function(){throw"stackPrefetch: batch failed for element: "+n.id})}}}}function i(o){var i=t.stackPrefetch.getConfiguration(),s=t.getToolState(o,u);s=[];var l=t.getToolState(o,"stack");if(void 0!==l&&void 0!==l.data&&0!==l.data.length){var d=l.data[0];(void 0===i||void 0===i.maxSimultaneousRequests)&&(i={maxSimultaneousRequests:Math.min(Math.ceil(d.imageIds.length/5),g)}),t.stackPrefetch.setConfiguration(i),s={indicesToRequest:r(0,d.imageIds.length-1),enabled:!0},t.addToolState(o,u,s),a(o),e(o).off("CornerstoneNewImage",n),e(o).on("CornerstoneNewImage",n)}}function s(o){e(o).off("CornerstoneNewImage",n);var r=t.getToolState(o,u);r&&r.data.length&&(r.data[0].enabled=!1,clearTimeout(c))}function l(){return f}function d(e){f=e}void 0===t&&(t={});var c,u="stackPrefetch",g=11,f={};return t.stackPrefetch={enable:i,disable:s,getConfiguration:l,setConfiguration:d},t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(o,t){e(t.element).off("CornerstoneToolsMouseDrag",a),e(t.element).off("CornerstoneToolsMouseUp",n)}function r(o,r){if(t.isMouseButtonEnabled(r.which,o.data.mouseButtonMask)){var i={deltaY:0,options:o.data.options};return e(r.element).on("CornerstoneToolsMouseDrag",i,a),e(r.element).on("CornerstoneToolsMouseUp",n),o.stopImmediatePropagation(),!1}}function a(o,n){o.data.deltaY+=n.deltaPoints.page.y;var r=n.element,a=t.getToolState(n.element,"stack");if(void 0!==a&&void 0!==a.data&&0!==a.data.length){var i=a.data[0],s=e(n.element).height()/i.imageIds.length;if(void 0!==o.data.options&&void 0!==o.data.options.stackScrollSpeed&&(s=o.data.options.stackScrollSpeed),o.data.deltaY>=s||o.data.deltaY<=-s){var l=o.data.deltaY/s,d=o.data.deltaY%s,c=Math.round(l);o.data.deltaY=d,t.scroll(r,c),e(r).trigger("CornerstoneImageScroll",{direction:c})}return!1}}function i(o,n){var r=-n.direction;t.scroll(n.element,r),e(n.element).trigger("CornerstoneImageScroll",{direction:r})}function s(o){var n=o.originalEvent.detail,r={deltaY:0},a=n.element;r.deltaY+=n.deltaPoints.page.y;var i=t.getToolState(n.element,"stack");if(void 0!==i&&void 0!==i.data&&0!==i.data.length){{i.data[0]}if(r.deltaY>=3||r.deltaY<=-3){var s=r.deltaY/3,l=r.deltaY%3,d=Math.round(s);r.deltaY=l,t.scroll(a,d),e(a).trigger("CornerstoneImageScroll",{direction:images})}return!1}}void 0===t&&(t={});return t.stackScroll=t.simpleMouseButtonTool(r),t.stackScrollWheel=t.mouseWheelTool(i),t.stackScrollTouchDrag=t.touchDragTool(s),t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(o,n){var a=n.keyCode;if(a===r.UP||a===r.DOWN){var i=1;a===r.DOWN&&(i=-1),t.scroll(n.element,i),e(n.element).trigger("CornerstoneImageScroll",{direction:i})}}void 0===t&&(t={});var r={UP:38,DOWN:40};return t.stackScrollKeyboard=t.keyboardTool(n),t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(){function e(e,t,n){var a=o.getEnabledElement(e);r.hasOwnProperty(a.image.imageId)===!1&&(r[a.image.imageId]={});var i=r[a.image.imageId];i.hasOwnProperty(t)===!1&&(i[t]={data:[]});var s=i[t];s.data.push(n)}function t(e,t){var n=o.getEnabledElement(e);if(r.hasOwnProperty(n.image.imageId)===!1)return void 0;var a=r[n.image.imageId];if(a.hasOwnProperty(t)===!1)return void 0;var i=a[t];return i}function n(e){var t=o.getEnabledElement(e);return r.hasOwnProperty(t.image.imageId)===!1?void 0:void delete r[t.image.imageId]}var r={},a={get:t,add:e,clear:n,toolState:r};return a}void 0===t&&(t={});var r=n();return t.newImageIdSpecificToolStateManager=n,t.globalImageIdSpecificToolStateManager=r,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(){function e(e){r=e}function o(){return r}function t(e){a=e}function n(){return a}var r,a,i={setStartLoadHandler:e,getStartLoadHandler:o,setEndLoadHandler:t,getEndLoadHandler:n};return i}return void 0===t&&(t={}),t.loadHandlerManager=n(),t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e,t){function n(n,r,i){if(!(e.indexOf(r)>=0))return t.add(n,r,i);o.getEnabledElement(n);a.hasOwnProperty(r)===!1&&(a[r]={data:[]});var s=a[r];s.data.push(i)}function r(o,n){if(e.indexOf(n)>=0){a.hasOwnProperty(n)===!1&&(a[n]={data:[]});var r=a[n];return r}return t.get(o,n)}var a={},i={get:r,add:n};return i}function r(e){var o=t.getElementToolStateManager(e);void 0===o&&(o=t.globalImageIdSpecificToolStateManager);var n=["stack","stackPrefetch","stackScroll","playClip","volume","slab","referenceLines","crosshairs"],r=t.newStackSpecificToolStateManager(n,o);a.push(r),t.setElementToolStateManager(e,r)}void 0===t&&(t={});var a=[];return t.newStackSpecificToolStateManager=n,t.addStackStateManager=r,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(){function e(e){s=e}function o(){return s}function t(e){i=e}function n(){return i}function r(e){l=e}function a(){return l}var i=15,s=i+"px Arial",l="transparent",d={setFont:e,getFont:o,setFontSize:t,getFontSize:n,setBackgroundColor:r,getBackgroundColor:a};return d}return void 0===t&&(t={}),t.textStyle=n(),t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e,t){function n(n,r,i){if(!(e.indexOf(r)>=0))return t.add(n,r,i);o.getEnabledElement(n);a.hasOwnProperty(r)===!1&&(a[r]={data:[]});var s=a[r];s.data.push(i)}function r(o,n){if(e.indexOf(n)>=0){a.hasOwnProperty(n)===!1&&(a[n]={data:[]});var r=a[n];return r}return t.get(o,n)}var a={},i={get:r,add:n};return i}function r(e,o){o=o||["timeSeries"];var n=t.getElementToolStateManager(e);void 0===n&&(n=t.globalImageIdSpecificToolStateManager);var r=t.newTimeSeriesSpecificToolStateManager(o,n);a.push(r),t.setElementToolStateManager(e,r)}void 0===t&&(t={});var a=[];return t.newTimeSeriesSpecificToolStateManager=n,t.addTimeSeriesStateManager=r,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(){function e(e){l=e}function o(){return l}function t(e){i=e}function n(){return i}function r(e){s=e}function a(){return s}var i="white",s="greenyellow",l="transparent",d={setFillColor:e,getFillColor:o,setToolColor:t,getToolColor:n,setActiveColor:r,getActiveColor:a};return d}return void 0===t&&(t={}),t.toolColors=n(),t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(){function e(e){t=e.currentPoints.image}function o(){return t}var t="",n={setCoords:e,getCoords:o};return n}return void 0===t&&(t={}),t.toolCoordinates=n(),t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e){var n=o.getEnabledElement(e);return void 0===n.toolStateManager&&(n.toolStateManager=t.globalImageIdSpecificToolStateManager),n.toolStateManager}function r(e,o,t){var r=n(e);r.add(e,o,t)}function a(e,o){var t=n(e);return t.get(e,o)}function i(e,o,t){for(var r=n(e),a=r.get(e,o),i=-1,s=0;s<a.data.length;s++)a.data[s]===t&&(i=s);-1!==i&&a.data.splice(i,1)}function s(e,o){var t=n(e),r=t.get(e,o);void 0!==r&&(r.data=[])}function l(e,t){var n=o.getEnabledElement(e);n.toolStateManager=t}return void 0===t&&(t={}),t.addToolState=r,t.getToolState=a,t.removeToolState=i,t.clearToolState=s,t.setElementToolStateManager=l,t.getElementToolStateManager=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(){function e(e){r=e}function o(){return r}function t(e){a=e}function n(){return a}var r=1,a=2,i={setToolWidth:e,getToolWidth:o,setActiveWidth:t,getActiveWidth:n};return i}return void 0===t&&(t={}),t.toolStyle=n(),t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e,t,n){if(n!==t){var r=o.getViewport(t),a=o.getViewport(n);(a.scale!==r.scale||a.translation.x!==r.translation.x||a.translation.y!==r.translation.y)&&(a.scale=r.scale,a.translation.x=r.translation.x,a.translation.y=r.translation.y,e.setViewport(n,a))}}return void 0===t&&(t={}),t.panZoomSynchronizer=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e,n,r){if(r!==n){var a=t.getToolState(n,"stack"),i=a.data[0],s=t.getToolState(r,"stack"),l=s.data[0],d=i.currentImageIdIndex;if(d=Math.min(Math.max(d,0),l.imageIds.length-1),d!==l.currentImageIdIndex){var c=t.loadHandlerManager.getStartLoadHandler(),u=t.loadHandlerManager.getEndLoadHandler();c&&c(r),o.loadAndCacheImage(l.imageIds[d]).then(function(t){var n=o.getViewport(r);l.currentImageIdIndex=d,e.displayImage(r,t,n),u&&u(r)})}}}return void 0===t&&(t={}),t.stackImageIndexSynchronizer=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(n,r,a){if(a!==r){var i=o.getEnabledElement(r).image,s=t.metaData.get("imagePlane",i.imageId),l=s.imagePositionPatient,d=t.getToolState(a,"stack"),c=d.data[0],u=Number.MAX_VALUE,g=-1;if(e.each(c.imageIds,function(e,o){var n=t.metaData.get("imagePlane",o),r=n.imagePositionPatient,a=r.distanceToSquared(l);u>a&&(u=a,g=e)}),g!==c.currentImageIdIndex){var f=t.loadHandlerManager.getStartLoadHandler(),v=t.loadHandlerManager.getEndLoadHandler();f&&f(a),-1!==g&&o.loadAndCacheImage(c.imageIds[g]).then(function(e){var t=o.getViewport(a);c.currentImageIdIndex=g,n.displayImage(a,e,t),v&&v(a)})}}}return void 0===t&&(t={}),t.stackImagePositionSynchronizer=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e,n,r,a){if(n!==r&&void 0!=a){var i=t.getToolState(r,"stack"),s=i.data[0],l=a.direction,d=s.currentImageIdIndex;d=0>l?d+1:d-1,d=Math.min(Math.max(d,0),s.imageIds.length-1),s.currentImageIdIndex!==d&&o.loadAndCacheImage(s.imageIds[d]).then(function(t){var n=o.getViewport(r);s.currentImageIdIndex=d,e.displayImage(r,t,n)})}}return void 0===t&&(t={}),t.stackScrollSynchronizer=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(t,n){function r(o,t){d=!0,e.each(l,function(e,r){n(i,o,r,t)}),d=!1}function a(e,o){d!==!0&&r(e.currentTarget,o)}var i=this,s=[],l=[],d=!1;this.addSource=function(o){var n=s.indexOf(o);-1===n&&(s.push(o),e(o).on(t,a),r(o))},this.addTarget=function(e){var o=l.indexOf(e);-1===o&&(l.push(e),n(i,e,e))},this.add=function(e){i.addSource(e),i.addTarget(e)},this.removeSource=function(o){var n=s.indexOf(o);-1!==n&&(s.splice(n,1),e(o).off(t,a),r(o))},this.removeTarget=function(e){var o=l.indexOf(e);-1!==o&&(l.splice(o,1),n(i,e,e))},this.remove=function(e){i.removeTarget(e),i.removeSource(e)},this.getSourceElements=function(){return s},this.displayImage=function(e,t,n){d=!0,o.displayImage(e,t,n),d=!1},this.setViewport=function(e,t){d=!0,o.setViewport(e,t),d=!1}}return void 0===t&&(t={}),t.Synchronizer=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e,t,n){n!==t&&o.updateImage(n)}return void 0===t&&(t={}),t.updateImageSynchronizer=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e,t,n){if(n!==t){var r=o.getViewport(t),a=o.getViewport(n);(a.voi.windowWidth!==r.voi.windowWidth||a.voi.windowCenter!==r.voi.windowCenter||a.invert!==r.invert)&&(a.voi.windowWidth=r.voi.windowWidth,a.voi.windowCenter=r.voi.windowCenter,a.invert=r.invert,e.setViewport(n,a))}}return void 0===t&&(t={}),t.wwwcSynchronizer=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e){var t=[];e.timeSeries.stacks.forEach(function(n){o.loadAndCacheImage(n.imageIds[e.imageIdIndex]).then(function(o){var n=Math.round(e.handles.end.x)+Math.round(e.handles.end.y)*o.width,r=o.getPixelData()[n];t.push(r)})}),e.lineSample.set(t)}function r(e){var o=t.getToolState(e.element,"timeSeries");if(void 0!==o&&void 0!==o.data&&0!==o.data.length){var r=o.data[0],a={timeSeries:r,lineSample:new t.LineSampleMeasurement,imageIdIndex:r.stacks[r.currentStackIndex].currentImageIdIndex,visible:!0,handles:{end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0}}};return n(a),t.MeasurementManager.add(a),a}}function a(e,n){var r=t.getToolState(e.currentTarget,i);if(void 0!==r){var a=n.canvasContext.canvas.getContext("2d");o.setToPixelCoordinateSystem(n.enabledElement,a);for(var s="white",l=0;l<r.data.length;l++){a.save();var d=r.data[l];a.beginPath(),t.drawHandles(a,n,d.handles,s),a.stroke();var c=t.setContextToDisplayFontSize(n.enabledElement,n.canvasContext,15);a.font=""+c.fontSize+"px Arial";var u=Math.round(d.handles.end.x),g=Math.round(d.handles.end.y);f=d.handles.end.x+3,v=d.handles.end.y-3;var f=f/c.fontScale,v=v/c.fontScale;a.fillStyle="white",a.fillText(""+u+","+g,f,v),a.restore()}}}void 0===t&&(t={});var i="probe4D";return t.probeTool4D=t.mouseButtonTool({createNewMeasurement:r,onImageRendered:a,toolType:i}),t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e,n,r){var a=t.getToolState(e,"timeSeries");if(void 0!==a&&void 0!==a.data&&0!==a.data.length){var i=a.data[0],s=i.stacks[i.currentStackIndex],l=s.currentImageIdIndex,d=i.currentStackIndex+n;if(r?(d>=i.stacks.length&&(d=0),0>d&&(d=i.stacks.length-1)):(d=Math.min(i.stacks.length-1,d),d=Math.max(0,d)),d!==i.currentStackIndex){var c=o.getViewport(e),u=i.stacks[d],g=t.loadHandlerManager.getStartLoadHandler(),f=t.loadHandlerManager.getEndLoadHandler();g&&g(e),o.loadAndCacheImage(u.imageIds[l]).then(function(t){i.currentImageIdIndex!==l&&(u.currentImageIdIndex=l,i.currentStackIndex=d,o.displayImage(e,t,c),f&&f(e))})}}}void 0===t&&(t={});return t.incrementTimePoint=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e,o){if(void 0===e)throw"playClip: element must not be undefined";void 0===o&&(o=30);var n=t.getToolState(e,"timeSeries");if(void 0!==n&&void 0!==n.data&&0!==n.data.length){var r,i=n.data[0],s=t.getToolState(e,a);void 0===s||0===s.data.length?(r={intervalId:void 0,framesPerSecond:o,lastFrameTimeStamp:void 0,frameRate:0},t.addToolState(e,a,r)):(r=s.data[0],r.framesPerSecond=o),void 0===r.intervalId&&(r.intervalId=setInterval(function(){i.stacks[i.currentStackIndex].currentImageIdIndex,i.currentStackIndex;r.framesPerSecond>0?t.incrementTimePoint(e,1,!0):t.incrementTimePoint(e,-1,!0)},1e3/Math.abs(r.framesPerSecond)))}}function r(e){var o,n=t.getToolState(e,a);void 0!==n&&0!==n.data.length&&(o=n.data[0],
clearInterval(o.intervalId),o.intervalId=void 0)}void 0===t&&(t={});var a="timeSeriesPlayer";return t.timeSeriesPlayer={start:n,stop:r},t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(o,t){e(t.element).off("CornerstoneToolsMouseDrag",a),e(t.element).off("CornerstoneToolsMouseUp",n)}function r(o,r){if(t.isMouseButtonEnabled(r.which,o.data.mouseButtonMask)){var i={deltaY:0,options:o.data.options};return e(r.element).on("CornerstoneToolsMouseDrag",i,a),e(r.element).on("CornerstoneToolsMouseUp",n),o.stopImmediatePropagation(),!1}}function a(o,n){o.data.deltaY+=n.deltaPoints.page.y;var r=t.getToolState(n.element,"timeSeries");if(void 0!==r&&void 0!==r.data&&0!==r.data.length){var a=r.data[0],i=e(n.element).height()/a.stacks.length;if(void 0!==o.data.options&&void 0!==o.data.options.timeSeriesScrollSpeed&&(i=o.data.options.timeSeriesScrollSpeed),o.data.deltaY>=i||o.data.deltaY<=-i){var s=Math.round(o.data.deltaY/i),l=o.data.deltaY%i;t.incrementTimePoint(n.element,s),o.data.deltaY=l}return!1}}function i(e,o){var n=-o.direction;t.incrementTimePoint(o.element,n)}function s(e){var o=e.originalEvent.detail,n={deltaY:0};n.deltaY+=o.deltaPoints.page.y;var r=t.getToolState(o.element,"stack");if(void 0!==r&&void 0!==r.data&&0!==r.data.length){if(n.deltaY>=3||n.deltaY<=-3){var a=n.deltaY/3,i=n.deltaY%3;t.setTimePoint(n.element,a),n.deltaY=i}return!1}}void 0===t&&(t={});return t.timeSeriesScroll=t.simpleMouseButtonTool(r),t.timeSeriesScrollWheel=t.mouseWheelTool(i),t.timeSeriesScrollTouchDrag=t.touchDragTool(s),t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e,o){var t=Math.pow(10,o);return Math.round(e*t)/t}return void 0===t&&(t={}),t.roundToDecimal=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e){"use strict";function o(e,o){if(void 0===e.data)return void 0;if("PT"!==e.data.string("x00080060"))return void 0;var t=o*e.slope+e.intercept,n=e.data.floatString("x00101030");if(void 0===n)return void 0;var r=e.data.elements.x00540016;if(void 0===r)return void 0;r=r.items[0].dataSet;var a=r.time("x00181072"),i=r.floatString("x00181074"),s=r.floatString("x00181075"),l=e.data.time("x00080032");if(!(a&&i&&s&&l))return void 0;var d=l.fractionalSeconds+l.seconds+60*l.minutes+60*l.hours*60,c=a.fractionalSeconds+a.seconds+60*a.minutes+60*a.hours*60,u=d-c,g=i*Math.exp(-u*Math.log(2)/s),f=t*n/g*1e3;return f}return void 0===e&&(e={}),e.calculateSUV=o,e}(cornerstoneTools),cornerstoneTools=function(e,o,t,n){"use strict";function r(e){var o=t.point.copy(e.page),n=t.point.copy(e.image);return{page:o,image:n}}return void 0===n&&(n={}),n.copyPoints=r,n}($,cornerstone,cornerstoneMath,cornerstoneTools),cornerstoneTools=function(e){"use strict";function o(e,o,t,n,r){var a=.5522848,i=n/2*a,s=r/2*a,l=o+n,d=t+r,c=o+n/2,u=t+r/2;e.beginPath(),e.moveTo(o,u),e.bezierCurveTo(o,u-s,c-i,t,c,t),e.bezierCurveTo(c+i,t,l,u-s,l,u),e.bezierCurveTo(l,u+s,c+i,d,c,d),e.bezierCurveTo(c-i,d,o,u+s,o,u),e.closePath(),e.stroke()}return void 0===e&&(e={}),e.drawEllipse=o,e}(cornerstoneTools),cornerstoneTools=function(e){"use strict";function o(o,t,n,r,a){var i=5,s=e.textStyle.getFont(),l=e.textStyle.getFontSize(),d=e.textStyle.getBackgroundColor();o.save(),o.font=s;var c=o.measureText(t).width;o.textBaseline="top",o.fillStyle=d,o.fillRect(n,r-l,c+2*i,l+2*i),o.fillStyle=a,o.fillText(t,n+i,r-l+i),o.restore()}return void 0===e&&(e={}),e.drawTextBox=o,e}(cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e,o){var t=1<<e-1;return 0!==(o&t)}return void 0===t&&(t={}),t.isMouseButtonEnabled=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e){return e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault(),e.cancelBubble=!0,e.returnValue=!1,!1}return void 0===t&&(t={}),t.pauseEvent=n,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o,t){"use strict";function n(e,o){var t=e.clone().sub(o.imagePositionPatient),n=o.rowCosines.dot(t)/o.columnPixelSpacing,r=o.columnCosines.dot(t)/o.rowPixelSpacing,a={x:n,y:r};return a}function r(e,o){var t=o.rowCosines.clone().multiplyScalar(e.x);t.multiplyScalar(o.columnPixelSpacing);var n=o.columnCosines.clone().multiplyScalar(e.y);n.multiplyScalar(o.rowPixelSpacing);var r=t.add(n);return r.add(o.imagePositionPatient),r}return void 0===t&&(t={}),void 0===t.referenceLines&&(t.referenceLines={}),t.projectPatientPointToImagePlane=n,t.imagePointToPatientPoint=r,t}($,cornerstone,cornerstoneTools),cornerstoneTools=function(e,o){"use strict";function t(e,t){var n=o.getToolState(e,"stack");if(void 0!==n&&void 0!==n.data&&0!==n.data.length){var r=n.data[0],a=r.currentImageIdIndex+t;a=Math.min(r.imageIds.length-1,a),a=Math.max(0,a),o.scrollToIndex(e,a)}}return void 0===o&&(o={}),o.scroll=t,o}(cornerstone,cornerstoneTools),cornerstoneTools=function(e,o){"use strict";function t(t,n){var r=o.getToolState(t,"stack");if(void 0!==r&&void 0!==r.data&&0!==r.data.length){var a=r.data[0];if(0>n&&(n+=a.imageIds.length),n!==a.currentImageIdIndex){var i=o.loadHandlerManager.getStartLoadHandler(),s=o.loadHandlerManager.getEndLoadHandler();i&&i(t),a.currentImageIdIndex=n;var l=e.getViewport(t);e.loadAndCacheImage(a.imageIds[n]).then(function(o){a.currentImageIdIndex===n&&(e.displayImage(t,o,l),s&&s(t))})}}}return void 0===o&&(o={}),o.scrollToIndex=t,o.loadHandlers={},o}(cornerstone,cornerstoneTools),cornerstone=function(e){"use strict";function o(o,t,n){var r=.1;e.setToPixelCoordinateSystem(o,t,r);var a=n/o.viewport.scale/r,i=n/o.viewport.scale/r;return{fontSize:a,lineHeight:i,fontScale:r}}return void 0===e&&(e={}),cornerstoneTools.setContextToDisplayFontSize=o,e}(cornerstone);